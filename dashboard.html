<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H&M - Dashboard [HOMOLOGA√á√ÉO] v2.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1f2937;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-info {
            background: #0ea5e9;
            color: white;
        }
        
        .btn-info:hover {
            background: #0284c7;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        .alert-success {
            background: #f0fdf4;
            border: 1px solid #22c55e;
            color: #16a34a;
        }
        
        .alert-error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #dc2626;
        }
        
        .alert-warning {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            color: #d97706;
        }
        
        .relatorio-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .pedido-item {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .pedido-header {
            background: #f9fafb;
            padding: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: background 0.2s;
        }
        
        .pedido-header:hover {
            background: #f3f4f6;
        }
        
        .pedido-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .pedido-info {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        
        .info-field {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 2px;
        }
        
        .info-value {
            color: #6b7280;
        }
        
        .expand-icon {
            font-size: 18px;
            color: #6b7280;
            transition: transform 0.2s;
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        .pedido-produtos {
            display: none;
            background: #fafafa;
            padding: 15px;
            border-top: 1px solid #e5e7eb;
        }
        
        .pedido-produtos.show {
            display: block;
        }
        
        .produto-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .produto-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            font-size: 13px;
        }
        
        .acoes-relatorio {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn-acao {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primario {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primario:hover {
            background: #2563eb;
        }
        
        .btn-secundario {
            background: #6b7280;
            color: white;
        }
        
        .btn-secundario:hover {
            background: #4b5563;
        }
        
        .contador-selecionados {
            margin-left: auto;
            font-weight: 500;
            color: #374151;
        }
    </style>
    <script>
        window.BACKEND_BASE_URL = window.BACKEND_BASE_URL || 'https://app-integracao-troquecommerce-x-mil-iota.vercel.app';
    </script>
</head>
<body>
    <!-- Bot√£o Voltar -->
    <div style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
        <a href="index.html" style="background: #6b7280; color: white; padding: 10px 20px; text-decoration: none; border-radius: 6px; font-size: 14px; display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            ‚Üê Voltar
        </a>
    </div>
    
    <!-- Banner de Homologa√ß√£o -->
    <div style="background: #f59e0b; color: white; text-align: center; padding: 8px; font-weight: bold; font-size: 14px;">
        üß™ AMBIENTE DE HOMOLOGA√á√ÉO - DADOS DE TESTE - N√ÉO USAR EM PRODU√á√ÉO
    </div>
    
    <div class="container">
        <h1 style="margin-bottom: 30px; color: #1f2937;">üìä Dashboard - Extra√ß√£o de IDs</h1>
        
        <!-- Busca de Pedido Espec√≠fico -->
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="margin-bottom: 15px; color: #374151;">üîç Buscar Pedido Espec√≠fico</h4>
            <div style="display: flex; gap: 10px; align-items: end;">
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #6b7280;">ID do Pedido:</label>
                    <input type="text" id="pedidoEspecificoId" value="1531830502307-01" placeholder="Ex: 1499999999899" 
                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                <button class="btn btn-primary" onclick="buscarPedidoEspecifico()">
                    <span>üîç</span>
                    <span>Buscar Pedido</span>
                </button>
            </div>
            <div id="pedidoEspecificoResultado" style="margin-top: 15px;"></div>
        </div>

        <!-- Buscar Todos os IDs -->
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="margin-bottom: 15px; color: #374151;">üìã Extrair Todos os IDs</h4>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn btn-primary" onclick="buscarTodosIds()">
                    <span>üìä</span>
                    <span>Buscar Todos os Pedidos</span>
                </button>
                <button class="btn btn-secondary" onclick="exportarIdsParaCSV()" id="btnExportarCSV" style="display: none;">
                    <span>üì•</span>
                    <span>Exportar CSV</span>
                </button>
                <button class="btn btn-info" onclick="buscarDetalhesTodosPedidos()" id="btnBuscarDetalhes" style="display: none;">
                    <span>üîç</span>
                    <span>Buscar Detalhes dos Pedidos</span>
                </button>
            </div>
            <div id="todosIdsResultado" style="margin-top: 15px;"></div>
        </div>
        
        <!-- Configura√ß√£o -->
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="margin-bottom: 15px; color: #374151;">‚öôÔ∏è Configura√ß√£o</h4>
            <div style="display: grid; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #6b7280;">Base URL:</label>
                    <input type="text" id="troqueBaseUrl" value="https://www.troquecommerce.com.br" placeholder="https://..." 
                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #6b7280;">Token:</label>
                    <input type="text" id="troqueToken" value="a7bf11c0-ef38-45b3-b336-9009df528385" placeholder="Informe o token da Troquecommerce" 
                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
            </div>
        </div>
        
        <!-- √Årea de Alertas -->
        <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 400px;"></div>
    </div>

    <script>
        // Vari√°veis globais
        let todosOsIds = [];
        let detalhesCompletosDosPedidos = [];

        // Fun√ß√µes de configura√ß√£o
        function getTroqueConfig() {
            const baseUrl = document.getElementById('troqueBaseUrl')?.value.trim();
            const token = document.getElementById('troqueToken')?.value.trim();
            return { baseUrl, token };
        }

        // Fun√ß√µes de alerta
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Buscar pedido espec√≠fico e gerar relat√≥rio
        async function buscarPedidoEspecifico() {
            const resultadoDiv = document.getElementById('pedidoEspecificoResultado');
            const pedidoId = document.getElementById('pedidoEspecificoId').value.trim();
            
            if (!pedidoId) {
                showAlert('Digite um ID de pedido!', 'warning');
                return;
            }
            
            try {
                resultadoDiv.innerHTML = '<div style="text-align: center; padding: 20px;">üîÑ Buscando pedido...</div>';
                
                const config = getTroqueConfig();
                const backendUrl = window.BACKEND_BASE_URL;
                
                const response = await fetch(`${backendUrl}/api/troquecommerce/order-detail`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        baseUrl: config.baseUrl,
                        token: config.token,
                        id: pedidoId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const pedidoData = await response.json();
                
                // Gerar relat√≥rio com checkboxes
                gerarRelatorioPedidos([pedidoData]);
                
                showAlert('Pedido encontrado e relat√≥rio gerado!', 'success');
                
            } catch (error) {
                console.error('Erro ao buscar pedido:', error);
                resultadoDiv.innerHTML = `
                    <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 6px; padding: 15px;">
                        <h5 style="color: #dc2626; margin: 0 0 10px 0;">‚ùå Erro na Busca</h5>
                        <p style="margin: 5px 0;">${error.message}</p>
                    </div>
                `;
                showAlert('Erro ao buscar pedido: ' + error.message, 'error');
            }
        }

        // Gerar relat√≥rio de pedidos com checkboxes
        function gerarRelatorioPedidos(pedidos) {
            const resultadoDiv = document.getElementById('pedidoEspecificoResultado');
            
            resultadoDiv.innerHTML = `
                <div class="relatorio-container">
                    <h3 style="margin-bottom: 20px; color: #1f2937;">üìã Relat√≥rio de Pedidos</h3>
                    
                    <div class="acoes-relatorio">
                        <button class="btn-acao btn-primario" onclick="adicionarSelecionadosAFila()">
                            üì§ Adicionar Selecionados √† Fila
                        </button>
                        <button class="btn-acao btn-secundario" onclick="selecionarTodos()">
                            ‚úÖ Selecionar Todos
                        </button>
                        <button class="btn-acao btn-secundario" onclick="deselecionarTodos()">
                            ‚ùå Deselecionar Todos
                        </button>
                        <span class="contador-selecionados" id="contadorSelecionados">
                            0 selecionados
                        </span>
                    </div>
                    
                    <div id="pedidosContainer">
                        ${pedidos.map((pedido, index) => gerarPedidoHTML(pedido, index)).join('')}
                    </div>
                </div>
            `;
            
            // Salvar pedidos globalmente para uso nas fun√ß√µes
            window.pedidosRelatorio = pedidos;
            atualizarContadorSelecionados();
        }

        // Gerar HTML para um pedido individual
        function gerarPedidoHTML(pedido, index) {
            return `
                <div class="pedido-item">
                    <div class="pedido-header" onclick="toggleProdutos(${index})">
                        <input type="checkbox" class="pedido-checkbox" id="pedido-${index}" value="${pedido.id}" onchange="atualizarContadorSelecionados()">
                        <div class="pedido-info">
                            <div class="info-field">
                                <span class="info-label">ID:</span>
                                <span class="info-value">${pedido.id}</span>
                            </div>
                            <div class="info-field">
                                <span class="info-label">N¬∫ E-commerce:</span>
                                <span class="info-value">${pedido.ecommerce_number}</span>
                            </div>
                            <div class="info-field">
                                <span class="info-label">Status:</span>
                                <span class="info-value">${traduzirStatus(pedido.status)}</span>
                            </div>
                            <div class="info-field">
                                <span class="info-label">Tipo:</span>
                                <span class="info-value">${traduzirTipo(pedido.reverse_type)}</span>
                            </div>
                            <div class="info-field">
                                <span class="info-label">Data Cria√ß√£o:</span>
                                <span class="info-value">${formatarData(pedido.created_at)}</span>
                            </div>
                            <div class="info-field">
                                <span class="info-label">Data Atualiza√ß√£o:</span>
                                <span class="info-value">${formatarData(pedido.updated_at)}</span>
                            </div>
                            <div class="info-field">
                                <span class="info-label">Cliente:</span>
                                <span class="info-value">${pedido.client?.name || 'N/A'}</span>
                            </div>
                        </div>
                        <span class="expand-icon" id="expand-${index}">‚ñº</span>
                    </div>
                    
                    <div class="pedido-produtos" id="produtos-${index}">
                        <h4 style="margin-bottom: 15px; color: #374151;">üì¶ Produtos do Pedido</h4>
                        ${pedido.items && pedido.items.length > 0 ? 
                            pedido.items.map(produto => gerarProdutoHTML(produto)).join('') :
                            '<p style="color: #6b7280; font-style: italic;">Nenhum produto encontrado.</p>'
                        }
                    </div>
                </div>
            `;
        }

        // Gerar HTML para um produto
        function gerarProdutoHTML(produto) {
            return `
                <div class="produto-item">
                    <div class="produto-info">
                        <div class="info-field">
                            <span class="info-label">ID Produto:</span>
                            <span class="info-value">${produto.ecommerce_product_id || 'N/A'}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">SKU:</span>
                            <span class="info-value">${produto.sku || 'N/A'}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">EAN:</span>
                            <span class="info-value">${produto.ean || 'N/A'}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Ref ID:</span>
                            <span class="info-value">${produto.ref_id || 'N/A'}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Descri√ß√£o:</span>
                            <span class="info-value">${produto.description || 'N/A'}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Pre√ßo:</span>
                            <span class="info-value">R$ ${(produto.price || 0).toFixed(2)}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Quantidade:</span>
                            <span class="info-value">${produto.quantity || 0}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Motivo:</span>
                            <span class="info-value">${produto.reason?.description || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Toggle produtos vis√≠veis
        function toggleProdutos(index) {
            const produtosDiv = document.getElementById(`produtos-${index}`);
            const expandIcon = document.getElementById(`expand-${index}`);
            
            produtosDiv.classList.toggle('show');
            expandIcon.classList.toggle('expanded');
        }

        // Atualizar contador de selecionados
        function atualizarContadorSelecionados() {
            const checkboxes = document.querySelectorAll('.pedido-checkbox:checked');
            const contador = document.getElementById('contadorSelecionados');
            if (contador) {
                contador.textContent = `${checkboxes.length} selecionados`;
            }
        }

        // Selecionar todos
        function selecionarTodos() {
            const checkboxes = document.querySelectorAll('.pedido-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            atualizarContadorSelecionados();
        }

        // Deselecionar todos
        function deselecionarTodos() {
            const checkboxes = document.querySelectorAll('.pedido-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            atualizarContadorSelecionados();
        }

        // Adicionar selecionados √† fila
        function adicionarSelecionadosAFila() {
            const checkboxes = document.querySelectorAll('.pedido-checkbox:checked');
            if (checkboxes.length === 0) {
                showAlert('Selecione pelo menos um pedido!', 'warning');
                return;
            }
            
            const selecionados = [];
            checkboxes.forEach(cb => {
                const pedidoId = cb.value;
                const pedido = window.pedidosRelatorio.find(p => p.id === pedidoId);
                if (pedido) {
                    selecionados.push(pedido);
                }
            });
            
            // Aqui voc√™ pode implementar a l√≥gica para adicionar √† fila
            console.log('Pedidos selecionados para fila:', selecionados);
            showAlert(`${selecionados.length} pedidos adicionados √† fila de processamento!`, 'success');
        }

        // Traduzir status
        function traduzirStatus(status) {
            const traduccoes = {
                'Aguardando': 'Aguardando',
                'Processando': 'Processando',
                'Finalizado': 'Finalizado',
                'Cancelado': 'Cancelado',
                'Pendente': 'Pendente'
            };
            return traduccoes[status] || status;
        }

        // Traduzir tipo
        function traduzirTipo(tipo) {
            const traduccoes = {
                'Troca e devolu√ß√£o': 'Troca e Devolu√ß√£o',
                'Troca': 'Troca',
                'Devolu√ß√£o': 'Devolu√ß√£o'
            };
            return traduccoes[tipo] || tipo;
        }

        // Formatar data
        function formatarData(dataString) {
            if (!dataString) return 'N/A';
            try {
                const data = new Date(dataString);
                return data.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dataString;
            }
        }

        // Copiar JSON
        function copiarJSON(pedidoId) {
            if (window.pedidoJSONCache && window.pedidoJSONCache[pedidoId]) {
                navigator.clipboard.writeText(window.pedidoJSONCache[pedidoId]).then(() => {
                    showAlert('JSON copiado para √°rea de transfer√™ncia!', 'success');
                }).catch(err => {
                    console.error('Erro ao copiar:', err);
                    showAlert('Erro ao copiar JSON', 'error');
                });
            }
        }

        // Buscar todos os IDs
        async function buscarTodosIds() {
            const resultadoDiv = document.getElementById('todosIdsResultado');
            const btnExportar = document.getElementById('btnExportarCSV');
            
            try {
                resultadoDiv.innerHTML = '<div style="text-align: center; padding: 20px;">üîÑ Buscando todos os pedidos...</div>';
                btnExportar.style.display = 'none';
                
                const config = getTroqueConfig();
                const backendUrl = window.BACKEND_BASE_URL;
                
                const listResponse = await fetch(`${backendUrl}/api/troquecommerce/order-list`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        baseUrl: config.baseUrl,
                        token: config.token,
                        unchecked_by_integration: true
                    })
                });

                if (!listResponse.ok) {
                    throw new Error(`HTTP ${listResponse.status}: ${await listResponse.text()}`);
                }

                const listData = await listResponse.json();
                const reversasList = listData.list || listData.data || listData.orders || [];
                
                todosOsIds = reversasList.map(pedido => ({
                    id: pedido.id,
                    ecommerce_number: pedido.ecommerce_number,
                    status: pedido.status,
                    created_at: pedido.created_at
                }));
                
                resultadoDiv.innerHTML = `
                    <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 6px; padding: 15px; margin-bottom: 15px;">
                        <h5 style="color: #16a34a; margin: 0 0 10px 0;">‚úÖ Busca Conclu√≠da!</h5>
                        <p style="margin: 5px 0;"><strong>Total de pedidos encontrados:</strong> ${reversasList.length}</p>
                        <p style="margin: 5px 0;"><strong>IDs extra√≠dos:</strong> ${todosOsIds.length}</p>
                        <p style="margin: 5px 0;"><strong>Data da busca:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                    </div>
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px;">
                        <h6 style="margin: 0 0 10px 0; color: #374151;">üìã Relat√≥rio de IDs:</h6>
                        <div style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                            ${todosOsIds.map(item => 
                                `<div style="padding: 2px 0; border-bottom: 1px solid #e5e7eb;">
                                    ID: ${item.id} | E-commerce: ${item.ecommerce_number} | Status: ${item.status}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
                
                btnExportar.style.display = 'inline-flex';
                document.getElementById('btnBuscarDetalhes').style.display = 'inline-flex';
                
                showAlert(`‚úÖ Encontrados ${todosOsIds.length} IDs de pedidos!`, 'success');
                
            } catch (error) {
                console.error('Erro ao buscar todos os IDs:', error);
                resultadoDiv.innerHTML = `
                    <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 6px; padding: 15px;">
                        <h5 style="color: #dc2626; margin: 0 0 10px 0;">‚ùå Erro na Busca</h5>
                        <p style="margin: 5px 0;">${error.message}</p>
                    </div>
                `;
                showAlert('Erro ao buscar IDs: ' + error.message, 'error');
            }
        }

        // Exportar IDs para CSV
        function exportarIdsParaCSV() {
            if (todosOsIds.length === 0) {
                showAlert('Nenhum ID para exportar!', 'warning');
                return;
            }
            
            let csvContent = "ID,E-commerce_number,Status,Created_at\n";
            todosOsIds.forEach(item => {
                csvContent += `"${item.id}","${item.ecommerce_number}","${item.status}","${item.created_at}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `pedidos_ids_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert(`üì• CSV exportado com ${todosOsIds.length} IDs!`, 'success');
        }

        // Buscar detalhes de todos os pedidos
        async function buscarDetalhesTodosPedidos() {
            if (todosOsIds.length === 0) {
                showAlert('Primeiro busque os IDs dos pedidos!', 'warning');
                return;
            }
            
            const resultadoDiv = document.getElementById('todosIdsResultado');
            const btnBuscarDetalhes = document.getElementById('btnBuscarDetalhes');
            
            try {
                btnBuscarDetalhes.disabled = true;
                btnBuscarDetalhes.innerHTML = '<span>üîÑ</span><span>Processando...</span>';
                
                resultadoDiv.innerHTML += '<div style="text-align: center; padding: 20px; margin-top: 15px;">üîç Buscando detalhes de todos os pedidos...</div>';
                
                const config = getTroqueConfig();
                const backendUrl = window.BACKEND_BASE_URL;
                detalhesCompletosDosPedidos = [];
                
                let processados = 0;
                let erros = 0;
                
                for (const pedidoInfo of todosOsIds) {
                    try {
                        console.log(`üîç Buscando detalhes do pedido ID: ${pedidoInfo.id}`);
                        
                        const detailResponse = await fetch(`${backendUrl}/api/troquecommerce/order-detail`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                baseUrl: config.baseUrl,
                                token: config.token,
                                id: pedidoInfo.id
                            })
                        });

                        if (detailResponse.ok) {
                            const detalhesPedido = await detailResponse.json();
                            
                            const pedidoCompleto = {
                                ...pedidoInfo,
                                detalhes: detalhesPedido
                            };
                            
                            detalhesCompletosDosPedidos.push(pedidoCompleto);
                            processados++;
                            
                            const progresso = Math.round((processados + erros) / todosOsIds.length * 100);
                            resultadoDiv.innerHTML = resultadoDiv.innerHTML.replace(
                                /üîç Buscando detalhes.*\(\d+\/\d+\)/,
                                `üîç Buscando detalhes... ${progresso}% (${processados + erros}/${todosOsIds.length})`
                            );
                            
                        } else {
                            console.error(`‚ùå Erro ao buscar detalhes do pedido ${pedidoInfo.id}:`, detailResponse.status);
                            erros++;
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (error) {
                        console.error(`‚ùå Erro ao processar pedido ${pedidoInfo.id}:`, error);
                        erros++;
                    }
                }
                
                resultadoDiv.innerHTML += `
                    <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 6px; padding: 15px; margin-top: 15px;">
                        <h5 style="color: #16a34a; margin: 0 0 10px 0;">‚úÖ Detalhes Conclu√≠dos!</h5>
                        <p style="margin: 5px 0;"><strong>Pedidos processados:</strong> ${processados}</p>
                        <p style="margin: 5px 0;"><strong>Erros:</strong> ${erros}</p>
                        <p style="margin: 5px 0;"><strong>Total de IDs:</strong> ${todosOsIds.length}</p>
                        <p style="margin: 5px 0;"><strong>Data da busca:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                        <button class="btn btn-success" onclick="exportarDetalhesParaCSV()" style="margin-top: 10px;">
                            <span>üì•</span>
                            <span>Exportar Detalhes Completos</span>
                        </button>
                    </div>
                `;
                
                showAlert(`‚úÖ Detalhes de ${processados} pedidos obtidos!`, 'success');
                
            } catch (error) {
                console.error('Erro ao buscar detalhes dos pedidos:', error);
                showAlert('Erro ao buscar detalhes: ' + error.message, 'error');
            } finally {
                btnBuscarDetalhes.disabled = false;
                btnBuscarDetalhes.innerHTML = '<span>üîç</span><span>Buscar Detalhes dos Pedidos</span>';
            }
        }

        // Exportar detalhes para CSV
        function exportarDetalhesParaCSV() {
            if (detalhesCompletosDosPedidos.length === 0) {
                showAlert('Nenhum detalhe para exportar!', 'warning');
                return;
            }
            
            let csvContent = "ID,E-commerce_number,Status,Cliente,Email,Total,Data_Criacao,Operador_Ultimo,Itens\n";
            
            detalhesCompletosDosPedidos.forEach(item => {
                const detalhes = item.detalhes;
                const cliente = detalhes.client || {};
                const itens = detalhes.items || [];
                const ultimoOperador = detalhes.history && detalhes.history.length > 0 
                    ? detalhes.history[detalhes.history.length - 1].created_by 
                    : 'Sistema';
                
                csvContent += `"${item.id}","${item.ecommerce_number}","${item.status}","${cliente.name || 'N/A'}","${cliente.email || 'N/A'}","${detalhes.price || 0}","${item.created_at}","${ultimoOperador}","${itens.length} itens"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `pedidos_detalhes_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert(`üì• CSV de detalhes exportado com ${detalhesCompletosDosPedidos.length} pedidos!`, 'success');
        }

        // Atalho de teclado
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'P') {
                e.preventDefault();
                const input = document.getElementById('pedidoEspecificoId');
                if (input) {
                    input.focus();
                    input.select();
                }
            }
        });

        console.log('‚úÖ Dashboard carregado!');
    </script>
</body>
</html>
