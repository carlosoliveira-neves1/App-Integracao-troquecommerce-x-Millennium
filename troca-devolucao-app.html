<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H&M - Sistema de Troca/Devolu√ß√£o Automatizado</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .nota-info {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .nota-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .nota-info-item {
            display: flex;
            flex-direction: column;
        }

        .nota-info-item label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .nota-info-item span {
            font-size: 14px;
            color: #111827;
            font-weight: 600;
        }

        .produtos-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .produto-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .produto-item:hover {
            border-color: #667eea;
        }

        .produto-item.selected {
            background: #ede9fe;
            border-color: #667eea;
        }

        .produto-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .produto-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .produto-info {
            flex: 1;
        }

        .produto-nome {
            font-weight: 600;
            color: #111827;
            margin-bottom: 5px;
        }

        .produto-detalhes {
            font-size: 12px;
            color: #6b7280;
        }

        .produto-preco {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        .produto-quantidade {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .produto-quantidade input {
            width: 80px;
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            text-align: center;
        }

        .fila-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 30px;
        }

        .fila-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .fila-stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .fila-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .fila-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .fila-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .fila-item-title {
            font-weight: 600;
            color: #111827;
            font-size: 16px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .fila-item-body {
            font-size: 14px;
            color: #6b7280;
        }

        .fila-item-body pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            margin-top: 10px;
        }

        .config-section {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-section h3 {
            font-size: 16px;
            color: #111827;
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .pedido-sem-nf {
            background: linear-gradient(135deg, #fff7ed, #fffbeb);
            border: 1px solid #fed7aa;
        }

        .pedido-sem-nf h3 {
            color: #9a3412;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        .search-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-options button {
            flex: 1;
        }

        .periodo-section {
            display: none;
            margin-bottom: 15px;
        }

        .periodo-section.active {
            display: block;
        }

        .notas-list {
            max-height: 600px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .nota-list-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .nota-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .nota-content {
            flex: 1;
        }

        .nota-list-item:hover {
            border-color: #667eea;
            background: #f3f4f6;
        }

        .nota-list-item.selected {
            background: #ede9fe;
            border-color: #667eea;
        }

        .nota-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .nota-list-title {
            font-weight: 600;
            color: #111827;
            font-size: 16px;
        }

        .nota-list-badge {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .nota-list-details {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.6;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn-group .btn {
            flex: 1;
        }

        .notas-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e5e7eb;
        }

        .notas-actions .btn {
            flex: 1 1 calc(33.33% - 10px);
        }

        .notas-summary {
            margin-top: 20px;
            background: #f9fafb;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .nota-summary-item {
            text-align: center;
        }

        .nota-summary-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nota-summary-value {
            font-size: 18px;
            font-weight: 700;
            color: #4c1d95;
        }

        .extra-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .extra-filters .form-group {
            flex: 1;
        }

        .schedule-fields {
            margin-top: 10px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 10px;
            border: 1px dashed #e5e7eb;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .weekdays label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #374151;
        }

        .schedule-hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 6px;
        }

        .troque-reversa-list {
            margin-top: 15px;
        }

        .troque-reversa-item {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            background: #f9fafb;
        }

        .troque-reversa-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .troque-reversa-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 999px;
            background: #e0e7ff;
            color: #3730a3;
            font-weight: 600;
        }

        .tab-header {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .tab-btn.active {
            background: #3b82f6;
            color: white;
        }

        .tab-content {
            display: block;
        }

        .webhook-events-list .webhook-event-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f9fafb;
        }

        .webhook-event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .webhook-event-id {
            font-weight: 600;
            color: #374151;
        }

        .webhook-event-type {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: #fef3c7;
            color: #92400e;
        }

        .webhook-event-meta {
            font-size: 14px;
            color: #6b7280;
        }

        .webhook-event-actions {
            margin-top: 10px;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Dashboard Styles */
        .dashboard-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 140px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dashboard-card h4 {
            margin: 0 0 10px 0;
            color: #374151;
            font-size: 14px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #3b82f6;
            margin: 10px 0;
            line-height: 1;
        }

        .metric-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: auto;
        }

        .dashboard-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            align-items: stretch;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .chart-container h4 {
            margin: 0 0 15px 0;
            color: #374151;
        }

        .dashboard-charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .recent-events {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .recent-events h4 {
            margin: 0 0 15px 0;
            color: #374151;
        }

        /* Configura√ß√£o Styles */
        .config-group {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .config-group h4 {
            margin: 0 0 15px 0;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .automation-status {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .automation-status h4 {
            margin: 0 0 15px 0;
            color: #374151;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-indicator.active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-indicator.inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .config-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .main-nav {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .nav-brand h1 {
                font-size: 18px;
                text-align: center;
            }

            .nav-menu {
                flex-direction: column;
                width: 100%;
            }

            .nav-btn {
                width: 100%;
                padding: 12px;
                font-size: 14px;
            }

            /* Dashboard Cards Mobile */
            .dashboard-metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }

            .dashboard-card {
                min-height: 120px;
                padding: 15px;
            }

            .metric-value {
                font-size: 24px;
            }

            .dashboard-card h4 {
                font-size: 12px;
            }

            /* Gr√°ficos Mobile */
            .chart-container {
                padding: 15px;
            }

            .dashboard-charts-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }

            #eventsByTypeChart, #eventsByDayChart {
                width: 100%;
                height: 150px;
            }

            /* Filtros Mobile */
            .form-group {
                margin-bottom: 15px;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            /* Cards Mobile */
            .card {
                padding: 20px;
                margin-bottom: 20px;
            }

            /* Tabela Mobile */
            .recent-events table {
                font-size: 12px;
            }

            .recent-events th,
            .recent-events td {
                padding: 6px;
            }

            /* Configura√ß√£o Mobile */
            .config-group {
                padding: 15px;
            }

            .config-actions {
                flex-direction: column;
            }

            .config-actions .btn {
                width: 100%;
            }

            /* Fila Mobile */
            .fila-container {
                padding: 20px;
            }

            .fila-stats {
                flex-direction: column;
                gap: 10px;
            }

            .stat-item {
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .nav-brand h1 {
                font-size: 16px;
            }

            .dashboard-card {
                min-height: 100px;
                padding: 10px;
            }

            .metric-value {
                font-size: 20px;
            }

            .metric-label {
                font-size: 10px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .main-nav {
                padding: 10px;
            }
        }

        /* Menu Principal */
        .main-nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-brand h1 {
            color: white;
            margin: 0;
            font-size: 24px;
        }

        .nav-menu {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .nav-btn.active {
            background: white;
            color: #667eea;
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .troque-reversa-meta {
            font-size: 13px;
            color: #4b5563;
            line-height: 1.5;
        }
    </style>
    <script>
        window.BACKEND_BASE_URL = window.BACKEND_BASE_URL || 'https://app-integracao-troquecommerce-x-mil.vercel.app';
    </script>
</head>
<body>
    <div class="container">
        <!-- Menu Principal -->
        <nav class="main-nav">
            <div class="nav-brand">
                <h1>üîÑ H&M - Sistema de Troca/Devolu√ß√£o Automatizado</h1>
            </div>
            <div class="nav-menu">
                <button class="nav-btn active" data-page="dashboard">üìä Dashboard</button>
                <button class="nav-btn" data-page="pedidos">üì¶ Pedidos</button>
                <button class="nav-btn" data-page="config">‚öôÔ∏è Configura√ß√µes</button>
            </div>
        </nav>

        <!-- P√°gina Dashboard -->
        <div id="dashboardPage" class="page-content active">
            <div class="config-section">
                <h3>üìä Dashboard de Relat√≥rios</h3>
                
                <!-- Filtros do Dashboard -->
                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #374151;">üîç Filtros do Dashboard</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Per√≠odo</label>
                            <select id="dashboardPeriod">
                                <option value="7">√öltimos 7 dias</option>
                                <option value="30">√öltimos 30 dias</option>
                                <option value="90">√öltimos 90 dias</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="form-group" id="dashboardDateRange" style="display: none;">
                            <label>Data Inicial</label>
                            <input type="date" id="dashboardDateStart">
                        </div>
                        <div class="form-group" id="dashboardDateRangeEnd" style="display: none;">
                            <label>Data Final</label>
                            <input type="date" id="dashboardDateEnd">
                        </div>
                        <div class="form-group">
                            <label>Tipo de Evento</label>
                            <select id="dashboardEventType">
                                <option value="">Todos os eventos</option>
                                <option value="1">1 - Reversa criada</option>
                                <option value="2">2 - Reversa aprovada</option>
                                <option value="3">3 - Reversa aprovada</option>
                                <option value="4">4 - Status alterado</option>
                                <option value="5">5 - Pedido de troca criado</option>
                                <option value="6">6 - Itens recebidos</option>
                                <option value="7">7 - Pedido de troca confirmado</option>
                                <option value="8">8 - Cupom gerado</option>
                                <option value="9">9 - Pagamento realizado</option>
                                <option value="10">10 - E-mail enviado</option>
                                <option value="11">11 - Objeto postado</option>
                                <option value="12">12 - Entrega realizada</option>
                                <option value="13">13 - Reversa finalizada</option>
                                <option value="14">14 - Reversa cancelada</option>
                                <option value="15">15 - Pedido de troca cancelado</option>
                                <option value="16">16 - Estorno realizado</option>
                                <option value="17">17 - Reembolso parcial</option>
                                <option value="18">18 - Reembolso total</option>
                                <option value="19">19 - Item retido</option>
                                <option value="20">20 - Item devolvido</option>
                                <option value="21">21 - Pedido de troca aprovado</option>
                                <option value="22">22 - Troca direta realizada</option>
                                <option value="23">23 - Segunda solicita√ß√£o</option>
                                <option value="24">24 - Exce√ß√£o identificada</option>
                                <option value="25">25 - Pedido de troca por produto criado</option>
                                <option value="26">26 - Pedido de troca por produto confirmado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status da Reversa</label>
                            <select id="dashboardStatus">
                                <option value="">Todos os status</option>
                                <option value="pending">Pendente</option>
                                <option value="in_transit">Em transporte</option>
                                <option value="delivered">Entregue</option>
                                <option value="approved">Aprovado</option>
                                <option value="finalizado">Finalizado</option>
                                <option value="cancelled">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>N√∫mero do Pedido</label>
                            <input type="text" id="dashboardOrderNumber" placeholder="Ex: 1603481046567-01">
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="applyDashboardFilters()">
                            <span>üîç</span>
                            <span>Aplicar Filtros</span>
                        </button>
                        <button class="btn btn-secondary" onclick="clearDashboardFilters()">
                            <span>üîÑ</span>
                            <span>Limpar Filtros</span>
                        </button>
                    </div>
                </div>
                
                <!-- Cards de Estat√≠sticas -->
                <div class="dashboard-metrics-grid">
                    <div class="dashboard-card">
                        <h4>üìà Total de Eventos</h4>
                        <div class="metric-value" id="totalEvents">0</div>
                        <div class="metric-label">√öltimos 7 dias</div>
                    </div>
                    <div class="dashboard-card">
                        <h4>üîÑ Reversas Ativas</h4>
                        <div class="metric-value" id="activeReversals">0</div>
                        <div class="metric-label">Em andamento</div>
                    </div>
                    <div class="dashboard-card">
                        <h4>‚úÖ Conclu√≠das</h4>
                        <div class="metric-value" id="completedReversals">0</div>
                        <div class="metric-label">Este m√™s</div>
                    </div>
                    <div class="dashboard-card">
                        <h4>üí∞ Valor Total</h4>
                        <div class="metric-value" id="totalValue">R$ 0</div>
                        <div class="metric-label">Em processamento</div>
                    </div>
                </div>

                <!-- Gr√°ficos -->
                <div class="dashboard-charts-grid">
                    <div class="chart-container">
                        <h4>üìä Eventos por Tipo</h4>
                        <canvas id="eventsByTypeChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>üìà Eventos por Dia</h4>
                        <canvas id="eventsByDayChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Tabela de Eventos Recentes -->
                <div class="recent-events">
                    <h4>üïê Eventos Recentes</h4>
                    <div id="recentEventsTable">
                        <div class="empty-state">
                            <p>Carregando eventos...</p>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="refreshDashboard()" style="margin-top: 20px;">
                    <span>üîÑ</span>
                    <span>Atualizar Dashboard</span>
                </button>
            </div>
        </div>

        <!-- P√°gina de Pedidos -->
        <div id="pedidosPage" class="page-content">
            <div class="form-row">
                <div class="form-group">
                    <label>URL Base</label>
                    <input type="text" id="baseUrl" value="http://177.85.161.219:6017" placeholder="http://servidor:porta">
                </div>
                <div class="card pedido-sem-nf" id="pedidoSemNotaCard" style="margin-top: 20px; display: none;">
                    <h2>üìÑ Dados do Pedido (sem NF)</h2>
                    <div id="pedidoSemNotaContainer" class="empty-state" style="padding: 20px;"></div>
                </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Usu√°rio</label>
                                <input type="text" id="username" value="integracao">
                            </div>
                            <div class="form-group">
                                <label>Senha</label>
                                <input type="password" id="password" value="Gh8#esM47">
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>Par√¢metros da Troca</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Vitrine</label>
                                <input type="number" id="vitrine" value="101">
                            </div>
                            <div class="form-group">
                                <label>Faturar</label>
                                <select id="faturar">
                                    <option value="A">A - Autom√°tico</option>
                                    <option value="M">M - Manual</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Autorizar NF-e</label>
                                <select id="autorizarNfe">
                                    <option value="T">T - Sim</option>
                                    <option value="F">F - N√£o</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo Autoriza√ß√£o Troca</label>
                                <input type="number" id="tipoAutorizacaoTroca" value="3">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tipo Pgto Cr√©dito <span style="color: #ef4444;">*</span></label>
                                <input type="number" id="tipoPgtoCredito" value="120" required>
                            </div>
                            <div class="form-group">
                                <label>Troca Valor Bruto</label>
                                <select id="trocaValorBruto">
                                    <option value="T">T - Sim</option>
                                    <option value="F">F - N√£o</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>üì± Notifica√ß√µes WhatsApp</h3>
                        <div class="form-group">
                            <label>N√∫mero Principal (Fixo)</label>
                            <input type="text" id="whatsappFixo" value="5511993110794" readonly style="background: #f3f4f6;">
                            <small style="color: #6b7280; font-size: 12px;">Formato: 55 + DDD + N√∫mero (sem espa√ßos ou caracteres especiais)</small>
                        </div>
                        <div class="form-group">
                            <label>N√∫meros Adicionais (opcional)</label>
                            <input type="text" id="whatsappAdicionais" placeholder="Ex: 5511999887766, 5511988776655">
                            <small style="color: #6b7280; font-size: 12px;">Separe m√∫ltiplos n√∫meros por v√≠rgula</small>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="enviarRelatorios" checked style="width: auto;">
                                <span>Enviar relat√≥rios autom√°ticos via WhatsApp</span>
                            </label>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>üåê Troquecommerce API</h3>
                        <div class="form-group">
                            <label>Base URL</label>
                            <input type="text" id="troqueBaseUrl" value="https://www.troquecommerce.com.br/api/public" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label>Token de Acesso</label>
                            <input type="text" id="troqueToken" placeholder="Informe o token da Troquecommerce">
                            <small style="color:#6b7280; font-size:12px;">O token √© enviado no header <code>token</code> (somente leitura j√° atende √† listagem).</small>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>üïí Agendamento do Processamento</h3>
                        <div class="form-group">
                            <label>Modo de agendamento</label>
                            <select id="scheduleMode">
                                <option value="off">Desativado</option>
                                <option value="daily">Todos os dias</option>
                                <option value="weekly">Dias espec√≠ficos da semana</option>
                                <option value="once">Data espec√≠fica</option>
                            </select>
                        </div>

                        <div id="scheduleDailyFields" class="schedule-fields" style="display: none;">
                            <div class="form-group">
                                <label>Hor√°rios (HH:MM)</label>
                                <input type="text" id="scheduleDailyTimes" placeholder="Ex: 09:00, 18:30">
                                <div class="schedule-hint">Separe m√∫ltiplos hor√°rios por v√≠rgula.</div>
                            </div>
                        </div>

                        <div id="scheduleWeeklyFields" class="schedule-fields" style="display: none;">
                            <div class="form-group">
                                <label>Dias da semana</label>
                                <div class="weekdays">
                                    <label><input type="checkbox" class="schedule-day-checkbox" value="1">Seg</label>
                                    <label><input type="checkbox" class="schedule-day-checkbox" value="2">Ter</label>
                                    <label><input type="checkbox" class="schedule-day-checkbox" value="3">Qua</label>
                                    <label><input type="checkbox" class="schedule-day-checkbox" value="4">Qui</label>
                                    <label><input type="checkbox" class="schedule-day-checkbox" value="5">Sex</label>
                                    <label><input type="checkbox" class="schedule-day-checkbox" value="6">S√°b</label>
                                    <label><input type="checkbox" class="schedule-day-checkbox" value="0">Dom</label>
                                </div>
                            </div>
                            <input type="hidden" id="scheduleWeeklyDays" value="">
                            <div class="form-group">
                                <label>Hor√°rios (HH:MM)</label>
                                <input type="text" id="scheduleWeeklyTimes" placeholder="Ex: 10:00, 22:00">
                                <div class="schedule-hint">Ser√° disparado nos dias selecionados e hor√°rios informados.</div>
                            </div>
                        </div>

                        <div id="scheduleOnceFields" class="schedule-fields" style="display: none;">
                            <div class="form-group">
                                <label>Data espec√≠fica</label>
                                <input type="date" id="scheduleOnceDate">
                            </div>
                            <div class="form-group">
                                <label>Hor√°rio (HH:MM)</label>
                                <input type="time" id="scheduleOnceTime">
                            </div>
                            <div class="schedule-hint">Ap√≥s executar, o agendamento √∫nico ser√° desativado automaticamente.</div>
                        </div>

                        <small class="schedule-hint">O processamento autom√°tico ocorre somente se houver itens pendentes na fila e a p√°gina estiver aberta.</small>
                    </div>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h2>üîç Buscar Nota Fiscal</h2>
                    <div id="alertContainer"></div>
                    
                    <div class="search-options">
                        <button class="btn btn-primary" id="btnModoNota" style="opacity: 1;">
                            üìÑ Por Nota
                        </button>
                        <button class="btn btn-primary" id="btnModoPeriodo" style="opacity: 0.6;">
                            üìÖ Por Per√≠odo
                        </button>
                        <button class="btn btn-primary" id="btnModoPedido" style="opacity: 0.6;">
                            üßæ Por Pedido
                        </button>
                    </div>

                    <!-- Busca por Nota -->
                    <div id="buscaNotaSection">
                        <div class="form-group">
                            <label>N√∫mero da Nota Fiscal</label>
                            <input type="number" id="numeroNota" placeholder="Ex: 71">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Data Inicial (quando n√£o informar nota)</label>
                                <input type="date" id="notaDataInicial">
                            </div>
                            <div class="form-group">
                                <label>Data Final (quando n√£o informar nota)</label>
                                <input type="date" id="notaDataFinal">
                            </div>
                        </div>
                        <small style="color: #6b7280; display: block; margin-top: -10px; margin-bottom: 15px;">
                            Se deixar o n√∫mero da nota vazio, buscaremos as notas faturadas dentro deste per√≠odo.
                        </small>
                        <button class="btn btn-primary" id="btnBuscar" style="width: 100%;">
                            <span>üîç</span>
                            <span>Buscar Nota</span>
                        </button>
                    </div>

                    <!-- Busca por Per√≠odo -->
                    <div id="buscaPeriodoSection" class="periodo-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Data Inicial</label>
                                <input type="date" id="dataInicial">
                            </div>
                            <div class="form-group">
                                <label>Data Final</label>
                                <input type="date" id="dataFinal">
                            </div>
                        </div>
                        <div class="extra-filters">
                            <div class="form-group">
                                <label>Valor M√≠nimo (R$)</label>
                                <input type="number" id="valorMin" step="0.01" placeholder="Ex: 100.00">
                            </div>
                            <div class="form-group">
                                <label>Valor M√°ximo (R$)</label>
                                <input type="number" id="valorMax" step="0.01" placeholder="Ex: 500.00">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="btnListarNotas" style="width: 100%;">
                            <span>üìã</span>
                            <span>Listar Notas do Per√≠odo</span>
                        </button>
                        <div id="notasListContainer" class="notas-list scrollbar"></div>
                        <div id="notasSummary" class="notas-summary" style="display: none;">
                            <div class="nota-summary-item">
                                <div class="nota-summary-label">Total de Notas</div>
                                <div class="nota-summary-value" id="summaryTotalNotas">0</div>
                            </div>
                            <div class="nota-summary-item">
                                <div class="nota-summary-label">Valor Total</div>
                                <div class="nota-summary-value" id="summaryValorTotal">R$ 0,00</div>
                            </div>
                            <div class="nota-summary-item">
                                <div class="nota-summary-label">Notas Selecionadas</div>
                                <div class="nota-summary-value" id="summarySelecionadas">0</div>
                            </div>
                        </div>
                        <div id="notasActionsContainer" class="notas-actions" style="display: none;">
                            <button class="btn btn-secondary" id="btnSelecionarTodas">
                                <span>‚òëÔ∏è</span>
                                <span>Selecionar Todas</span>
                            </button>
                            <button class="btn btn-secondary" id="btnDeselecionarTodas">
                                <span>‚¨ú</span>
                                <span>Limpar Sele√ß√£o</span>
                            </button>
                            <button class="btn btn-primary" id="btnCarregarSelecionadas">
                                <span>üì•</span>
                                <span>Carregar Selecionadas</span>
                            </button>
                            <button class="btn btn-secondary" id="btnExportarNotas">
                                <span>üìÑ</span>
                                <span>Exportar CSV</span>
                            </button>
                        </div>
                    </div>

                    <!-- Busca por Pedido -->
                    <div id="buscaPedidoSection" class="periodo-section">
                        <div class="form-group">
                            <label>N√∫mero do Pedido</label>
                            <input type="text" id="numeroPedido" placeholder="Ex: 1606840505580-01">
                        </div>
                        <button class="btn btn-primary" id="btnBuscarPedido" style="width: 100%;">
                            <span>üì¶</span>
                            <span>Buscar Pedido</span>
                        </button>
                    </div>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <div class="tab-header">
                        <button class="tab-btn active" data-tab="reversasTab">üîÅ Reversas</button>
                        <button class="tab-btn" data-tab="webhookTab">üì® Eventos Webhook</button>
                        <button class="tab-btn" data-tab="dashboardTab">üìä Dashboard</button>
                        <button class="tab-btn" data-tab="configTab">‚öôÔ∏è Configura√ß√µes</button>
                    </div>
                    <!-- Reversas Tab Content -->
                    <div class="tab-content" id="reversasTab">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Status da reversa</label>
                                <select id="troqueStatusFiltro">
                                    <option value="">Todos</option>
                                    <option value="pending">Pendente</option>
                                    <option value="in_transit">Em transporte</option>
                                    <option value="ready_to_return">Pronta para devolu√ß√£o</option>
                                    <option value="finished">Finalizada</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Data inicial</label>
                                <input type="date" id="troqueDataInicial">
                            </div>
                            <div class="form-group">
                                <label>Data final</label>
                                <input type="date" id="troqueDataFinal">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="btnBuscarReversas" style="width: 100%; margin-bottom: 15px;">
                            <span>üîÅ</span>
                            <span>Buscar Reversas</span>
                        </button>
                        
                        <!-- Controles de Sele√ß√£o e Pagina√ß√£o -->
                        <div id="reversasControls" style="display: none; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 5px; margin: 0;">
                                        <input type="checkbox" id="selectAllReversas">
                                        <span>Marcar todos</span>
                                    </label>
                                    <span id="selectedCount" style="font-size: 14px; color: #666;">0 selecionados</span>
                                </div>
                                <button class="btn btn-success btn-sm" id="btnAdicionarSelecionadas" disabled>
                                    <span>‚ûï</span>
                                    <span>Adicionar √† Fila</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Pagina√ß√£o -->
                        <div id="paginationContainer" style="display: none; margin-bottom: 15px; text-align: center;"></div>
                        
                        <div id="troqueReversasContainer" class="troque-reversa-list">
                            <div class="empty-state" style="padding: 30px 20px;">
                                <p>Use os filtros acima para listar as reversas abertas na Troquecommerce.</p>
                            </div>
                        </div>
                    </div>
            </div>

            <!-- Webhook Events Section -->
            <div class="tab-content" id="webhookTab" style="display: none;">
                <div class="config-section">
                    <h3>üì® Eventos Recebidos via Webhook</h3>
                    <div class="form-group">
                        <label>Filtrar por tipo de evento</label>
                        <select id="webhookEventFilter">
                            <option value="">Todos os eventos</option>
                            <option value="1">1 - Reversa criada</option>
                            <option value="2">2 - Reversa aprovada</option>
                            <option value="3">3 - Reversa aprovada</option>
                            <option value="4">4 - Status alterado</option>
                            <option value="5">5 - Pedido de troca criado</option>
                            <option value="6">6 - Itens recebidos</option>
                            <option value="7">7 - Pedido de troca confirmado</option>
                            <option value="8">8 - Cupom gerado</option>
                            <option value="9">9 - Pagamento realizado</option>
                            <option value="10">10 - E-mail enviado</option>
                            <option value="11">11 - Objeto postado</option>
                            <option value="12">12 - Entrega realizada</option>
                            <option value="13">13 - Reversa finalizada</option>
                            <option value="14">14 - Reversa cancelada</option>
                            <option value="15">15 - Pedido de troca cancelado</option>
                            <option value="16">16 - Estorno realizado</option>
                            <option value="17">17 - Reembolso parcial</option>
                            <option value="18">18 - Reembolso total</option>
                            <option value="19">19 - Item retido</option>
                            <option value="20">20 - Item devolvido</option>
                            <option value="21">21 - Pedido de troca aprovado</option>
                            <option value="22">22 - Troca direta realizada</option>
                            <option value="23">23 - Segunda solicita√ß√£o</option>
                            <option value="24">24 - Exce√ß√£o identificada</option>
                            <option value="25">25 - Pedido de troca por produto criado</option>
                            <option value="26">26 - Pedido de troca por produto confirmado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filtrar por per√≠odo</label>
                        <div class="form-row">
                            <div class="form-group">
                                <input type="datetime-local" id="webhookDataInicial">
                            </div>
                            <div class="form-group">
                                <input type="datetime-local" id="webhookDataFinal">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="btnBuscarEventos" style="width: 100%; margin-bottom: 15px;">
                        <span>üì®</span>
                        <span>Buscar Eventos</span>
                    </button>
                    <div id="webhookEventsContainer" class="webhook-events-list">
                        <div class="empty-state" style="padding: 30px 20px;">
                            <p>Clique em "Buscar Eventos" para listar os eventos recebidos via webhook.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div class="tab-content" id="dashboardTab" style="display: none;">
                <div class="config-section">
                    <h3>üìä Dashboard de Relat√≥rios</h3>
                    
                    <!-- Cards de Estat√≠sticas -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div class="dashboard-card">
                            <h4>üìà Total de Eventos</h4>
                            <div class="metric-value" id="totalEvents">0</div>
                            <div class="metric-label">√öltimos 7 dias</div>
                        </div>
                        <div class="dashboard-card">
                            <h4>üîÑ Reversas Ativas</h4>
                            <div class="metric-value" id="activeReversals">0</div>
                            <div class="metric-label">Em andamento</div>
                        </div>
                        <div class="dashboard-card">
                            <h4>‚úÖ Conclu√≠das</h4>
                            <div class="metric-value" id="completedReversals">0</div>
                            <div class="metric-label">Este m√™s</div>
                        </div>
                        <div class="dashboard-card">
                            <h4>üí∞ Valor Total</h4>
                            <div class="metric-value" id="totalValue">R$ 0</div>
                            <div class="metric-label">Em processamento</div>
                        </div>
                    </div>

                    <!-- Gr√°ficos -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div class="chart-container">
                            <h4>üìä Eventos por Tipo</h4>
                            <canvas id="eventsByTypeChart" width="400" height="200"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>üìà Eventos por Dia</h4>
                            <canvas id="eventsByDayChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Tabela de Eventos Recentes -->
                    <div class="recent-events">
                        <h4>üïê Eventos Recentes</h4>
                        <div id="recentEventsTable">
                            <div class="empty-state">
                                <p>Carregando eventos...</p>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="refreshDashboard()" style="margin-top: 20px;">
                        <span>üîÑ</span>
                        <span>Atualizar Dashboard</span>
                    </button>
                </div>
            </div>

            <!-- Configura√ß√£o Section -->
            <div class="tab-content" id="configTab" style="display: none;">
                <div class="config-section">
                    <h3>‚öôÔ∏è Configura√ß√µes de Automa√ß√£o</h3>
                    
                    <!-- Configura√ß√£o de Busca Autom√°tica -->
                    <div class="config-group">
                        <h4>üîç Busca Autom√°tica de Reversas</h4>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="autoSearchEnabled">
                                Habilitar busca autom√°tica
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Intervalo de busca</label>
                            <select id="searchInterval">
                                <option value="60000">1 minuto</option>
                                <option value="300000" selected>5 minutos</option>
                                <option value="600000">10 minutos</option>
                                <option value="1800000">30 minutos</option>
                                <option value="3600000">1 hora</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status para buscar</label>
                            <select id="autoSearchStatus">
                                <option value="">Todos</option>
                                <option value="pending">Pendente</option>
                                <option value="in_transit">Em transporte</option>
                                <option value="delivered">Entregue</option>
                                <option value="approved">Aprovado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Per√≠odo para busca (dias)</label>
                            <input type="number" id="autoSearchDays" value="7" min="1" max="30">
                        </div>
                    </div>

                    <!-- Configura√ß√£o de Processamento Autom√°tico -->
                    <div class="config-group">
                        <h4>‚ö° Processamento Autom√°tico</h4>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="autoProcessEnabled">
                                Adicionar notas encontradas automaticamente √† fila
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="autoProcessOnlyWithInvoice">
                                Apenas com nota fiscal dispon√≠vel
                            </label>
                        </div>
                    </div>

                    <!-- Configura√ß√£o de Notifica√ß√µes -->
                    <div class="config-group">
                        <h4>üîî Notifica√ß√µes</h4>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="notificationNewEvents">
                                Notificar novos eventos recebidos
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="notificationErrors">
                                Notificar erros de processamento
                            </label>
                        </div>
                    </div>

                    <!-- Status da Automa√ß√£o -->
                    <div class="automation-status">
                        <h4>üìä Status da Automa√ß√£o</h4>
                        <div class="status-item">
                            <span>Busca Autom√°tica:</span>
                            <span id="autoSearchStatus" class="status-indicator inactive">Inativa</span>
                        </div>
                        <div class="status-item">
                            <span>√öltima Busca:</span>
                            <span id="lastSearchTime">Nunca</span>
                        </div>
                        <div class="status-item">
                            <span>Pr√≥xima Busca:</span>
                            <span id="nextSearchTime">‚Äî</span>
                        </div>
                        <div class="status-item">
                            <span>Total de Buscas:</span>
                            <span id="totalSearches">0</span>
                        </div>
                    </div>

                    <!-- Bot√µes de Controle -->
                    <div class="config-actions">
                        <button class="btn btn-success" id="btnStartAutomation">
                            <span>‚ñ∂Ô∏è</span>
                            <span>Iniciar Automa√ß√£o</span>
                        </button>
                        <button class="btn btn-danger" id="btnStopAutomation" disabled>
                            <span>‚èπÔ∏è</span>
                            <span>Parar Automa√ß√£o</span>
                        </button>
                        <button class="btn btn-secondary" onclick="saveConfig()">
                            <span>üíæ</span>
                            <span>Salvar Configura√ß√µes</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Coluna 2: Dados da Nota e Produtos -->
            <div>
                <div class="card">
                    <h2>üìÑ Dados da Nota</h2>
                    <div id="notaInfoContainer">
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p>Busque uma nota fiscal para ver os detalhes</p>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h2>üì¶ Produtos para Troca/Devolu√ß√£o</h2>
                    <div id="produtosContainer">
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                            <p>Nenhum produto dispon√≠vel</p>
                        </div>
                    </div>
                    <button class="btn btn-success" id="btnAdicionarFila" style="width: 100%; margin-top: 20px;" disabled>
                        <span>‚ûï</span>
                        <span>Adicionar √† Fila</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Fila de Processamento -->
        <div class="fila-container">
            <div class="fila-header">
                <h2>üìã Fila de Processamento</h2>
                <div class="fila-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statPending">0</div>
                        <div class="stat-label">Pendentes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statSuccess">0</div>
                        <div class="stat-label">Sucesso</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statError">0</div>
                        <div class="stat-label">Erros</div>
                    </div>
                </div>
                <button class="btn btn-success" id="btnProcessarFila" disabled>
                    <span>‚ñ∂Ô∏è</span>
                    <span>Processar Fila</span>
                </button>
            </div>
            <div class="fila-list scrollbar" id="filaList">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <p>Nenhuma troca/devolu√ß√£o na fila</p>
                </div>
            </div>
        </div>

        <!-- P√°gina de Configura√ß√µes -->
        <div id="configPage" class="page-content">
            <div class="config-group">
                <h3>‚öôÔ∏è Configura√ß√µes de Automa√ß√£o</h3>
                
                <!-- Configura√ß√£o de Busca Autom√°tica -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #374151; border-bottom: 1px solid #e5e7eb; padding-bottom: 10px;">üîç Busca Autom√°tica de Reversas</h4>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoSearchEnabled">
                            Habilitar busca autom√°tica
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Intervalo de busca</label>
                        <select id="searchInterval">
                            <option value="60000">1 minuto</option>
                            <option value="300000" selected>5 minutos</option>
                            <option value="600000">10 minutos</option>
                            <option value="1800000">30 minutos</option>
                            <option value="3600000">1 hora</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status para buscar</label>
                        <select id="autoSearchStatus">
                            <option value="">Todos</option>
                            <option value="pending">Pendente</option>
                            <option value="in_transit">Em transporte</option>
                            <option value="delivered">Entregue</option>
                            <option value="approved">Aprovado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Per√≠odo para busca (dias)</label>
                        <input type="number" id="autoSearchDays" value="7" min="1" max="30">
                    </div>
                </div>

                <!-- Configura√ß√£o de Processamento Autom√°tico -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #374151; border-bottom: 1px solid #e5e7eb; padding-bottom: 10px;">‚ö° Processamento Autom√°tico</h4>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoProcessEnabled">
                            Adicionar notas encontradas automaticamente √† fila
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoProcessOnlyWithInvoice">
                            Apenas com nota fiscal dispon√≠vel
                        </label>
                    </div>
                </div>

                <!-- Configura√ß√£o de Notifica√ß√µes -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #374151; border-bottom: 1px solid #e5e7eb; padding-bottom: 10px;">üîî Notifica√ß√µes</h4>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="notificationNewEvents">
                            Notificar novos eventos recebidos
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="notificationErrors">
                            Notificar erros de processamento
                        </label>
                    </div>
                </div>

                <!-- Status da Automa√ß√£o -->
                <div class="automation-status">
                    <h4>üìä Status da Automa√ß√£o</h4>
                    <div class="status-item">
                        <span>Busca Autom√°tica:</span>
                        <span id="autoSearchStatus" class="status-indicator inactive">Inativa</span>
                    </div>
                    <div class="status-item">
                        <span>√öltima Busca:</span>
                        <span id="lastSearchTime">Nunca</span>
                    </div>
                    <div class="status-item">
                        <span>Pr√≥xima Busca:</span>
                        <span id="nextSearchTime">‚Äî</span>
                    </div>
                    <div class="status-item">
                        <span>Total de Buscas:</span>
                        <span id="totalSearches">0</span>
                    </div>
                </div>

                <!-- Bot√µes de Controle -->
                <div class="config-actions">
                    <button class="btn btn-success" id="btnStartAutomation">
                        <span>‚ñ∂Ô∏è</span>
                        <span>Iniciar Automa√ß√£o</span>
                    </button>
                    <button class="btn btn-danger" id="btnStopAutomation" disabled>
                        <span>‚èπÔ∏è</span>
                        <span>Parar Automa√ß√£o</span>
                    </button>
                    <button class="btn btn-secondary" onclick="saveConfig()">
                        <span>üíæ</span>
                        <span>Salvar Configura√ß√µes</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado da aplica√ß√£o
        const state = {
            notaAtual: null,
            produtosSelecionados: [],
            fila: [],
            processando: false,
            notasEncontradas: [],
            notasFiltradas: [],
            scheduleTimer: null,
            ultimoAgendamentoExecutado: null,
            troqueReversas: [],
            webhookEvents: [],
            currentPage: 1,
            itemsPerPage: 10,
            selectedReversas: new Set(),
            // Automa√ß√£o
            automationTimer: null,
            automationConfig: {
                autoSearchEnabled: false,
                searchInterval: 300000, // 5 minutos
                autoSearchStatus: '',
                autoSearchDays: 7,
                autoProcessEnabled: false,
                autoProcessOnlyWithInvoice: true,
                notificationNewEvents: true,
                notificationErrors: true
            },
            automationStats: {
                totalSearches: 0,
                lastSearchTime: null,
                nextSearchTime: null
            },
            // Filtros do Dashboard
            dashboardFilters: {
                period: '7',
                dateStart: null,
                dateEnd: null,
                eventType: '',
                status: '',
                orderNumber: ''
            },
            // Atualiza√ß√£o autom√°tica do dashboard
            dashboardUpdateTimer: null,
            dashboardUpdateInterval: 30000, // 30 segundos
            lastDashboardUpdate: null
        };

        const CONFIG_STORAGE_KEY = 'trocaDev_config';
        const CONFIG_FIELD_IDS = [
            'baseUrl','username','password','vitrine','faturar','autorizarNfe',
            'tipoAutorizacaoTroca','tipoPgtoCredito','trocaValorBruto',
            'whatsappFixo','whatsappAdicionais','enviarRelatorios',
            'troqueBaseUrl','troqueToken',
            'scheduleMode','scheduleDailyTimes','scheduleWeeklyTimes','scheduleWeeklyDays',
            'scheduleOnceDate','scheduleOnceTime'
        ];
        const MAX_NOTAS_PROCESSADAS = 200;

        // Elementos DOM
        const elements = {
            btnBuscar: document.getElementById('btnBuscar'),
            btnAdicionarFila: document.getElementById('btnAdicionarFila'),
            btnProcessarFila: document.getElementById('btnProcessarFila'),
            btnModoNota: document.getElementById('btnModoNota'),
            btnModoPeriodo: document.getElementById('btnModoPeriodo'),
            btnModoPedido: document.getElementById('btnModoPedido'),
            btnListarNotas: document.getElementById('btnListarNotas'),
            btnSelecionarTodas: document.getElementById('btnSelecionarTodas'),
            btnDeselecionarTodas: document.getElementById('btnDeselecionarTodas'),
            btnCarregarSelecionadas: document.getElementById('btnCarregarSelecionadas'),
            btnBuscarPedido: document.getElementById('btnBuscarPedido'),
            numeroNota: document.getElementById('numeroNota'),
            notaDataInicial: document.getElementById('notaDataInicial'),
            notaDataFinal: document.getElementById('notaDataFinal'),
            dataInicial: document.getElementById('dataInicial'),
            dataFinal: document.getElementById('dataFinal'),
            numeroPedido: document.getElementById('numeroPedido'),
            valorMin: document.getElementById('valorMin'),
            valorMax: document.getElementById('valorMax'),
            buscaNotaSection: document.getElementById('buscaNotaSection'),
            buscaPeriodoSection: document.getElementById('buscaPeriodoSection'),
            buscaPedidoSection: document.getElementById('buscaPedidoSection'),
            notasListContainer: document.getElementById('notasListContainer'),
            notasActionsContainer: document.getElementById('notasActionsContainer'),
            notasSummary: document.getElementById('notasSummary'),
            summaryTotalNotas: document.getElementById('summaryTotalNotas'),
            summaryValorTotal: document.getElementById('summaryValorTotal'),
            summarySelecionadas: document.getElementById('summarySelecionadas'),
            btnExportarNotas: document.getElementById('btnExportarNotas'),
            notaInfoContainer: document.getElementById('notaInfoContainer'),
            produtosContainer: document.getElementById('produtosContainer'),
            filaList: document.getElementById('filaList'),
            alertContainer: document.getElementById('alertContainer'),
            statTotal: document.getElementById('statTotal'),
            statPending: document.getElementById('statPending'),
            statSuccess: document.getElementById('statSuccess'),
            statError: document.getElementById('statError'),
            pedidoSemNotaCard: document.getElementById('pedidoSemNotaCard'),
            pedidoSemNotaContainer: document.getElementById('pedidoSemNotaContainer'),
            statError: document.getElementById('statError'),
            scheduleMode: document.getElementById('scheduleMode'),
            scheduleDailyFields: document.getElementById('scheduleDailyFields'),
            scheduleDailyTimes: document.getElementById('scheduleDailyTimes'),
            scheduleWeeklyFields: document.getElementById('scheduleWeeklyFields'),
            scheduleWeeklyTimes: document.getElementById('scheduleWeeklyTimes'),
            scheduleWeeklyDays: document.getElementById('scheduleWeeklyDays'),
            scheduleDayCheckboxes: document.querySelectorAll('.schedule-day-checkbox'),
            scheduleOnceFields: document.getElementById('scheduleOnceFields'),
            scheduleOnceDate: document.getElementById('scheduleOnceDate'),
            scheduleOnceTime: document.getElementById('scheduleOnceTime'),
            troqueBaseUrl: document.getElementById('troqueBaseUrl'),
            troqueToken: document.getElementById('troqueToken'),
            troqueStatusFiltro: document.getElementById('troqueStatusFiltro'),
            troqueDataInicial: document.getElementById('troqueDataInicial'),
            troqueDataFinal: document.getElementById('troqueDataFinal'),
            btnBuscarReversas: document.getElementById('btnBuscarReversas'),
            troqueReversasContainer: document.getElementById('troqueReversasContainer'),
            webhookEventFilter: document.getElementById('webhookEventFilter'),
            webhookDataInicial: document.getElementById('webhookDataInicial'),
            webhookDataFinal: document.getElementById('webhookDataFinal'),
            btnBuscarEventos: document.getElementById('btnBuscarEventos'),
            webhookEventsContainer: document.getElementById('webhookEventsContainer'),
            selectAllReversas: document.getElementById('selectAllReversas'),
            btnAdicionarSelecionadas: document.getElementById('btnAdicionarSelecionadas'),
            paginationContainer: document.getElementById('paginationContainer'),
            selectedCount: document.getElementById('selectedCount'),
            reversasControls: document.getElementById('reversasControls'),
            // Dashboard
            totalEvents: document.getElementById('totalEvents'),
            activeReversals: document.getElementById('activeReversals'),
            completedReversals: document.getElementById('completedReversals'),
            totalValue: document.getElementById('totalValue'),
            recentEventsTable: document.getElementById('recentEventsTable'),
            // Configura√ß√£o
            autoSearchEnabled: document.getElementById('autoSearchEnabled'),
            searchInterval: document.getElementById('searchInterval'),
            autoSearchStatus: document.getElementById('autoSearchStatus'),
            autoSearchDays: document.getElementById('autoSearchDays'),
            autoProcessEnabled: document.getElementById('autoProcessEnabled'),
            autoProcessOnlyWithInvoice: document.getElementById('autoProcessOnlyWithInvoice'),
            notificationNewEvents: document.getElementById('notificationNewEvents'),
            notificationErrors: document.getElementById('notificationErrors'),
            autoSearchStatusIndicator: document.getElementById('autoSearchStatus'),
            lastSearchTime: document.getElementById('lastSearchTime'),
            nextSearchTime: document.getElementById('nextSearchTime'),
            totalSearches: document.getElementById('totalSearches'),
            btnStartAutomation: document.getElementById('btnStartAutomation'),
            btnStopAutomation: document.getElementById('btnStopAutomation'),
            // Filtros do Dashboard
            dashboardPeriod: document.getElementById('dashboardPeriod'),
            dashboardDateStart: document.getElementById('dashboardDateStart'),
            dashboardDateEnd: document.getElementById('dashboardDateEnd'),
            dashboardEventType: document.getElementById('dashboardEventType'),
            dashboardStatus: document.getElementById('dashboardStatus'),
            dashboardOrderNumber: document.getElementById('dashboardOrderNumber')
        };

        // Fun√ß√µes de utilidade
        function showAlert(message, type = 'info') {
            const alertClass = `alert-${type}`;
            elements.alertContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                elements.alertContainer.innerHTML = '';
            }, 5000);
        }

        function updateScheduleFieldsVisibility() {
            const mode = elements.scheduleMode.value;
            elements.scheduleDailyFields.style.display = mode === 'daily' ? 'block' : 'none';
            elements.scheduleWeeklyFields.style.display = mode === 'weekly' ? 'block' : 'none';
            elements.scheduleOnceFields.style.display = mode === 'once' ? 'block' : 'none';
        }

        function getWeeklyDaysList() {
            const raw = elements.scheduleWeeklyDays.value || '';
            return raw.split(',').map(v => v.trim()).filter(Boolean);
        }

        function applyWeeklyDaysToCheckboxes() {
            const ativos = new Set(getWeeklyDaysList());
            elements.scheduleDayCheckboxes.forEach(cb => {
                cb.checked = ativos.has(cb.value);
            });
        }

        function updateWeeklyDaysFromCheckboxes() {
            const selecionados = Array.from(elements.scheduleDayCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            elements.scheduleWeeklyDays.value = selecionados.join(',');
        }

        function parseScheduleTimes(value) {
            if (!value) return [];
            return value.split(',')
                .map(v => v.trim())
                .filter(Boolean)
                .map(time => {
                    const [h, m] = time.split(':').map(Number);
                    if (Number.isInteger(h) && Number.isInteger(m) && h >= 0 && h < 24 && m >= 0 && m < 60) {
                        return h * 60 + m;
                    }
                    return null;
                })
                .filter(v => v !== null);
        }

        function shouldTriggerDaily(nowMinutes) {
            const times = parseScheduleTimes(elements.scheduleDailyTimes.value);
            return times.includes(nowMinutes) ? `${nowMinutes}` : null;
        }

        function shouldTriggerWeekly(nowMinutes, weekday) {
            const diasSelecionados = getWeeklyDaysList();
            if (!diasSelecionados.includes(String(weekday))) return null;
            const times = parseScheduleTimes(elements.scheduleWeeklyTimes.value);
            return times.includes(nowMinutes) ? `${weekday}-${nowMinutes}` : null;
        }

        function shouldTriggerOnce(now) {
            const data = elements.scheduleOnceDate.value;
            const horario = elements.scheduleOnceTime.value;
            if (!data || !horario) return null;
            const dataAtual = now.toISOString().split('T')[0];
            if (data !== dataAtual) return null;
            const times = parseScheduleTimes(horario);
            const minutos = now.getHours() * 60 + now.getMinutes();
            return times.includes(minutos) ? `${data}-${minutos}` : null;
        }

        function hasPendingItems() {
            return state.fila.some(item => item.status === 'pending');
        }

        function getBackendBaseUrl() {
            if (window.BACKEND_BASE_URL) return window.BACKEND_BASE_URL;
            const origin = window.location.origin;
            if (origin && origin !== 'null' && !origin.startsWith('file:')) {
                return origin;
            }
            return 'http://localhost:4000';
        }

        function getTroqueConfig() {
            const baseUrl = elements.troqueBaseUrl?.value.trim();
            const token = elements.troqueToken?.value.trim();
            return { baseUrl, token };
        }

        function normalizarTroqueUrl(baseUrl = '') {
            if (!baseUrl) return '';
            return baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
        }

        function formatarDataHora(dataString) {
            if (!dataString) return 'N/A';
            const date = new Date(dataString);
            if (Number.isNaN(date.getTime())) return dataString;
            return date.toLocaleString('pt-BR');
        }

        function formatarTroqueStatus(status) {
            if (!status) return '‚Äî';
            return status.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
        }

        function renderTroqueReversas() {
            const container = elements.troqueReversasContainer;
            const reversas = state.troqueReversas || [];

            if (!container) return;

            // Mostrar/ocultar controles
            if (reversas.length > 0) {
                elements.reversasControls.style.display = 'block';
                elements.paginationContainer.style.display = 'block';
            } else {
                elements.reversasControls.style.display = 'none';
                elements.paginationContainer.style.display = 'none';
                container.innerHTML = '<div class="empty-state" style="padding: 30px 20px;"><p>Nenhuma reversa encontrada para os filtros informados.</p></div>';
                return;
            }

            // Calcular pagina√ß√£o
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const endIndex = startIndex + state.itemsPerPage;
            const pageReversas = reversas.slice(startIndex, endIndex);
            const totalPages = Math.ceil(reversas.length / state.itemsPerPage);

            // Renderizar pagina√ß√£o
            renderPagination(totalPages);

            // Renderizar reversas da p√°gina atual
            container.innerHTML = pageReversas.map((reversa, pageIndex) => {
                const globalIndex = startIndex + pageIndex;
                const reversaId = reversa.id || `#${globalIndex + 1}`;
                const pedidoOriginal = reversa?.ecommerce_number || 'N/A';
                const status = formatarTroqueStatus(reversa.status);
                const createdAt = formatarDataHora(reversa.created_at);
                const cliente = reversa?.client?.name || 'Cliente n√£o informado';
                const motivo = reversa?.reverse_type || '-';
                const preco = reversa?.price ? `R$ ${reversa.price.toFixed(2)}` : 'Pre√ßo n√£o informado';
                const reembolso = reversa?.refund_value ? `R$ ${reversa.refund_value.toFixed(2)}` : 'Reembolso n√£o informado';
                
                // Log√≠stica reversa
                const tracking = reversa?.tracking;
                const trackingInfo = tracking ? `
                    <p><strong>Transportadora:</strong> ${tracking.courier_company || 'N/A'}</p>
                    <p><strong>C√≥digo Rastreio:</strong> ${tracking.courier_tracking_code || 'N/A'}</p>
                    <p><strong>Coleta:</strong> ${tracking.courier_collect_number || 'N/A'}</p>
                    <p><strong>Status Entrega:</strong> ${tracking.status || 'N/A'}</p>
                    ${tracking.expected_delivery_date ? `<p><strong>Prev. Entrega:</strong> ${formatarDataHora(tracking.expected_delivery_date)}</p>` : ''}
                ` : '<p><strong>Log√≠stica:</strong> N√£o dispon√≠vel</p>';

                // Hist√≥rico (√∫ltimos 3 eventos)
                const history = reversa?.history || [];
                const recentHistory = history.slice(-3).reverse();
                const historyInfo = recentHistory.length > 0 ? recentHistory.map(h => 
                    `<li><small>${formatarDataHora(h.created_at)} - ${h.description}</small></li>`
                ).join('') : '<li><small>Sem hist√≥rico dispon√≠vel</small></li>';

                const isSelected = state.selectedReversas.has(globalIndex);

                return `
                    <div class="troque-reversa-item" style="position: relative;">
                        <div class="troque-reversa-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="reversa-checkbox" data-index="${globalIndex}" ${isSelected ? 'checked' : ''}>
                                <div>
                                    <strong>Reversa ${reversaId}</strong><br>
                                    <small>Pedido original: ${pedidoOriginal}</small>
                                </div>
                            </div>
                            <span class="troque-reversa-status">${status}</span>
                        </div>
                        <div class="troque-reversa-meta">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                                <div>
                                    <p><strong>Cliente:</strong> ${cliente}</p>
                                    <p><strong>Criada em:</strong> ${createdAt}</p>
                                    <p><strong>Tipo:</strong> ${motivo}</p>
                                    <p><strong>Valor:</strong> ${preco}</p>
                                    <p><strong>Reembolso:</strong> ${reembolso}</p>
                                </div>
                                <div>
                                    <p><strong>üì¶ Log√≠stica Reversa:</strong></p>
                                    ${trackingInfo}
                                </div>
                            </div>
                            <div style="margin-top: 10px;">
                                <p><strong>üìã Hist√≥rico Recente:</strong></p>
                                <ul style="margin: 5px 0; padding-left: 20px;">
                                    ${historyInfo}
                                </ul>
                            </div>
                            <button class="btn btn-primary troque-reversa-carregar" data-index="${globalIndex}" style="margin-top:10px; width: 100%;">
                                <span>üì•</span>
                                <span>Carregar nota no Millennium</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Adicionar event listeners
            container.querySelectorAll('.reversa-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    if (e.target.checked) {
                        state.selectedReversas.add(index);
                    } else {
                        state.selectedReversas.delete(index);
                    }
                    updateSelectedCount();
                    updateSelectAllCheckbox();
                });
            });

            container.querySelectorAll('.troque-reversa-carregar').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const idx = parseInt(event.currentTarget.dataset.index, 10);
                    await carregarReversaNoMillennium(idx);
                });
            });

            updateSelectedCount();
            updateSelectAllCheckbox();
        }

        function renderPagination(totalPages) {
            const container = elements.paginationContainer;
            if (!container || totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let paginationHTML = '<div style="display: flex; justify-content: center; align-items: center; gap: 5px;">';
            
            // Bot√£o anterior
            if (state.currentPage > 1) {
                paginationHTML += `<button class="btn btn-secondary btn-sm" onclick="changePage(${state.currentPage - 1})">‚Üê</button>`;
            }

            // N√∫meros das p√°ginas
            for (let i = 1; i <= totalPages; i++) {
                if (i === state.currentPage) {
                    paginationHTML += `<button class="btn btn-primary btn-sm">${i}</button>`;
                } else if (Math.abs(i - state.currentPage) <= 2 || i === 1 || i === totalPages) {
                    paginationHTML += `<button class="btn btn-secondary btn-sm" onclick="changePage(${i})">${i}</button>`;
                } else if (Math.abs(i - state.currentPage) === 3) {
                    paginationHTML += `<span style="padding: 0 5px;">...</span>`;
                }
            }

            // Bot√£o pr√≥ximo
            if (state.currentPage < totalPages) {
                paginationHTML += `<button class="btn btn-secondary btn-sm" onclick="changePage(${state.currentPage + 1})">‚Üí</button>`;
            }

            paginationHTML += '</div>';
            paginationHTML += `<div style="text-align: center; margin-top: 5px; font-size: 14px; color: #666;">P√°gina ${state.currentPage} de ${totalPages}</div>`;
            
            container.innerHTML = paginationHTML;
        }

        function changePage(page) {
            state.currentPage = page;
            state.selectedReversas.clear();
            renderTroqueReversas();
        }

        function updateSelectedCount() {
            const count = state.selectedReversas.size;
            elements.selectedCount.textContent = `${count} selecionado${count !== 1 ? 's' : ''}`;
            elements.btnAdicionarSelecionadas.disabled = count === 0;
        }

        function updateSelectAllCheckbox() {
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const endIndex = startIndex + state.itemsPerPage;
            const pageReversas = state.troqueReversas.slice(startIndex, endIndex);
            
            let allSelected = pageReversas.length > 0;
            for (let i = 0; i < pageReversas.length; i++) {
                if (!state.selectedReversas.has(startIndex + i)) {
                    allSelected = false;
                    break;
                }
            }
            
            elements.selectAllReversas.checked = allSelected;
        }

        async function adicionarSelecionadasAFila() {
            if (state.selectedReversas.size === 0) {
                showAlert('Nenhuma reversa selecionada.', 'warning');
                return;
            }

            const config = getConfig();
            let adicionados = 0;
            let erros = 0;

            for (const index of state.selectedReversas) {
                const reversa = state.troqueReversas[index];
                if (!reversa) continue;

                try {
                    // Buscar nota da reversa
                    const numeroNota = reversa?.invoice?.number || reversa?.nota || reversa?.nf || reversa?.invoice_number;
                    
                    if (numeroNota) {
                        // Nota direto dispon√≠vel
                        await carregarNotaPorNumero(numeroNota, config.vitrine);
                    } else {
                        // Buscar pelo pedido
                        const numeroPedido = reversa?.ecommerce_number || reversa?.original_order_number || reversa?.order_number;
                        if (numeroPedido) {
                            const pedidos = await consultarPedidosMillennium({ numeroPedidoCliente: numeroPedido });
                            if (pedidos && pedidos.length > 0) {
                                const pedido = pedidos[0];
                                const notaPedido = obterNumeroNota(pedido);
                                if (notaPedido && notaPedido !== '0') {
                                    await carregarNotaPorNumero(notaPedido, config.vitrine);
                                } else {
                                    throw new Error('Pedido sem nota fiscal emitida');
                                }
                            } else {
                                throw new Error('Pedido n√£o encontrado no Millennium');
                            }
                        } else {
                            throw new Error('N√£o foi poss√≠vel identificar o pedido');
                        }
                    }
                    
                    adicionados++;
                } catch (error) {
                    console.error(`Erro ao adicionar reversa ${reversa.id}:`, error);
                    erros++;
                }
            }

            // Limpar sele√ß√£o
            state.selectedReversas.clear();
            renderTroqueReversas();

            // Mostrar resultado
            if (adicionados > 0) {
                showAlert(`${adicionados} nota(s) adicionada(s) √† fila com sucesso${erros > 0 ? ` e ${erros} erro(s)` : ''}.`, erros > 0 ? 'warning' : 'success');
            } else {
                showAlert('N√£o foi poss√≠vel adicionar nenhuma nota √† fila.', 'error');
            }
        }

        async function buscarReversasTroque() {
            const { baseUrl, token } = getTroqueConfig();
            if (!baseUrl || !token) {
                showAlert('Informe a Base URL e o Token da Troquecommerce antes de buscar as reversas.', 'error');
                return;
            }

            const status = elements.troqueStatusFiltro?.value;
            const dataInicial = elements.troqueDataInicial?.value;
            const dataFinal = elements.troqueDataFinal?.value;
            const params = new URLSearchParams();
            if (status) params.append('status', status);
            if (dataInicial) params.append('start_date', `${dataInicial}T00:00:00.000Z`);
            if (dataFinal) params.append('end_date', `${dataFinal}T23:59:59.999Z`);

            const backendUrl = getBackendBaseUrl();
            const payload = {
                baseUrl: normalizarTroqueUrl(baseUrl),
                token,
                status: status || undefined,
                start_date: dataInicial ? `${dataInicial}T00:00:00.000Z` : undefined,
                end_date: dataFinal ? `${dataFinal}T23:59:59.999Z` : undefined
            };

            elements.btnBuscarReversas.disabled = true;
            const btnOriginalText = elements.btnBuscarReversas.innerHTML;
            elements.btnBuscarReversas.innerHTML = '<span class="loading"></span> Buscando...';

            try {
                const response = await fetch(`${backendUrl}/api/troquecommerce/order-list`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text || response.statusText}`);
                }

                const data = await response.json();
                let reversas = [];
                if (Array.isArray(data)) {
                    reversas = data;
                } else if (Array.isArray(data?.list)) {
                    reversas = data.list;
                } else if (Array.isArray(data?.data)) {
                    reversas = data.data;
                } else if (Array.isArray(data?.orders)) {
                    reversas = data.orders;
                } else if (Array.isArray(data?.items)) {
                    reversas = data.items;
                }

                state.troqueReversas = reversas;
                renderTroqueReversas();
                showAlert(`${reversas.length} reversa(s) encontrada(s) na Troquecommerce.`, 'success');
                
                // Atualizar dashboard em background se estiver ativo
                if (document.getElementById('dashboardPage').classList.contains('active')) {
                    setTimeout(refreshDashboardBackground, 500);
                }

            } catch (error) {
                console.error('Erro ao buscar reversas na Troquecommerce:', error);
                showAlert(`Erro ao buscar reversas: ${error.message}`, 'error');
                state.troqueReversas = [];
                renderTroqueReversas();
            } finally {
                elements.btnBuscarReversas.disabled = false;
                elements.btnBuscarReversas.innerHTML = btnOriginalText;
            }
        }

        async function carregarReversaNoMillennium(index) {
            const reversa = state.troqueReversas?.[index];
            if (!reversa) {
                showAlert('Reversa selecionada n√£o encontrada na lista atual.', 'error');
                return;
            }

            const config = getConfig();
            const numeroNotaDireto = reversa?.invoice?.number || reversa?.nota || reversa?.nf || reversa?.invoice_number;
            if (numeroNotaDireto) {
                await carregarNotaPorNumero(numeroNotaDireto, config.vitrine);
                showAlert(`Nota ${numeroNotaDireto} carregada a partir da reversa ${reversa.id || reversa.code}.`, 'success');
                return;
            }

            const numeroPedido = reversa?.original_order_number || reversa?.order_number || reversa?.orderNumber || reversa?.pedido || null;
            if (!numeroPedido) {
                showAlert('N√£o foi poss√≠vel identificar o pedido original desta reversa.', 'error');
                return;
            }

            showAlert(`Buscando pedido ${numeroPedido} no Millennium...`, 'info');
            try {
                const pedidos = await consultarPedidosMillennium({ numeroPedidoCliente: numeroPedido });
                if (!pedidos || pedidos.length === 0) {
                    throw new Error('Pedido n√£o encontrado no Millennium');
                }

                const pedido = pedidos[0];
                const numeroNotaPedido = obterNumeroNota(pedido);
                if (!numeroNotaPedido || numeroNotaPedido === '0') {
                    throw new Error('Pedido localizado, por√©m ainda sem nota fiscal emitida');
                }

                await carregarNotaPorNumero(numeroNotaPedido, config.vitrine);
                showAlert(`Nota ${numeroNotaPedido} carregada (pedido ${numeroPedido}) para a reversa selecionada.`, 'success');

            } catch (error) {
                console.error('Erro ao carregar nota via reversa:', error);
                showAlert(`N√£o foi poss√≠vel carregar a nota para a reversa: ${error.message}`, 'error');
            }
        }

        // Fun√ß√µes para navega√ß√£o principal
        function initNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn');
            const pageContents = document.querySelectorAll('.page-content');

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetPage = button.dataset.page;
                    
                    // Remove active class from all buttons and contents
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    pageContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button and show corresponding content
                    button.classList.add('active');
                    document.getElementById(targetPage + 'Page').classList.add('active');
                    
                    // Gerenciar atualiza√ß√£o autom√°tica do dashboard
                    if (targetPage === 'dashboard') {
                        // Iniciar atualiza√ß√£o autom√°tica ao entrar na p√°gina
                        startDashboardAutoUpdate();
                        // For√ßar atualiza√ß√£o imediata se n√£o tiver dados recentes
                        if (!state.lastDashboardUpdate || (Date.now() - state.lastDashboardUpdate.getTime()) > 60000) {
                            setTimeout(refreshDashboard, 100);
                        }
                    } else {
                        // Parar atualiza√ß√£o autom√°tica ao sair da p√°gina
                        stopDashboardAutoUpdate();
                    }
                });
            });
        }

        // Fun√ß√µes para abas e eventos webhook
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.style.display = 'none');
                    
                    // Add active class to clicked button and show corresponding content
                    button.classList.add('active');
                    document.getElementById(targetTab).style.display = 'block';
                });
            });
        }

        async function buscarEventosWebhook() {
            const backendUrl = getBackendBaseUrl();
            const eventFilter = elements.webhookEventFilter?.value;
            const dataInicial = elements.webhookDataInicial?.value;
            const dataFinal = elements.webhookDataFinal?.value;

            elements.btnBuscarEventos.disabled = true;
            const btnOriginalText = elements.btnBuscarEventos.innerHTML;
            elements.btnBuscarEventos.innerHTML = '<span class="loading"></span> Buscando eventos...';

            try {
                // Buscar todos os eventos do backend
                const response = await fetch(`${backendUrl}/api/troquecommerce/webhook-events`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                let todosEventos = data.events || [];

                // Aplicar filtros no frontend
                let eventosFiltrados = todosEventos;

                if (eventFilter) {
                    eventosFiltrados = eventosFiltrados.filter(evt => evt.eventId === eventFilter);
                }

                if (dataInicial) {
                    const dataInicio = new Date(dataInicial);
                    eventosFiltrados = eventosFiltrados.filter(evt => new Date(evt.timestamp) >= dataInicio);
                }

                if (dataFinal) {
                    const dataFim = new Date(dataFinal);
                    eventosFiltrados = eventosFiltrados.filter(evt => new Date(evt.timestamp) <= dataFim);
                }

                state.webhookEvents = eventosFiltrados;
                renderWebhookEvents();
                showAlert(`${eventosFiltrados.length} evento(s) encontrado(s) de ${data.count || 0} total.`, 'success');
                
                // Atualizar dashboard em background se estiver ativo
                if (document.getElementById('dashboardPage').classList.contains('active')) {
                    setTimeout(refreshDashboardBackground, 500);
                }

            } catch (error) {
                console.error('Erro ao buscar eventos webhook:', error);
                showAlert(`Erro ao buscar eventos: ${error.message}`, 'error');
                state.webhookEvents = [];
                renderWebhookEvents();
            } finally {
                elements.btnBuscarEventos.disabled = false;
                elements.btnBuscarEventos.innerHTML = btnOriginalText;
            }
        }

        function renderWebhookEvents() {
            const container = elements.webhookEventsContainer;
            const eventos = state.webhookEvents || [];

            if (!container) return;

            if (eventos.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 30px 20px;"><p>Nenhum evento encontrado para os filtros informados.</p></div>';
                return;
            }

            container.innerHTML = eventos.map((evento, index) => {
                const timestamp = formatarDataHora(evento.timestamp);
                const receivedAt = formatarDataHora(evento.receivedAt);
                const payload = evento.payload || {};
                const client = payload.client || {};
                const price = payload.price ? `R$ ${payload.price.toFixed(2)}` : 'N/A';
                const refundValue = payload.refund_value ? `R$ ${payload.refund_value.toFixed(2)}` : 'N/A';

                return `
                    <div class="webhook-event-item">
                        <div class="webhook-event-header">
                            <div>
                                <span class="webhook-event-id">${evento.id}</span>
                                <small style="margin-left: 10px;">Recebido: ${receivedAt}</small>
                            </div>
                            <span class="webhook-event-type">${evento.eventId} - ${evento.eventName}</span>
                        </div>
                        <div class="webhook-event-meta">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <p><strong>ID Reversa:</strong> ${payload.id || 'N/A'}</p>
                                    <p><strong>Pedido:</strong> ${payload.ecommerce_number || 'N/A'}</p>
                                    <p><strong>Status:</strong> ${payload.status || 'N/A'}</p>
                                </div>
                                <div>
                                    <p><strong>Cliente:</strong> ${client.name || 'N/A'}</p>
                                    <p><strong>Valor:</strong> ${price}</p>
                                    <p><strong>Reembolso:</strong> ${refundValue}</p>
                                </div>
                            </div>
                            <p><strong>Tipo:</strong> ${payload.reverse_type || 'N/A'}</p>
                            <p><strong>Criado em:</strong> ${payload.created_at ? formatarDataHora(payload.created_at) : 'N/A'}</p>
                            ${payload.items ? `<p><strong>Itens:</strong> ${payload.items.length} item(s)</p>` : ''}
                        </div>
                        <div class="webhook-event-actions">
                            <button class="btn btn-primary btn-sm" onclick="buscarNotaDoEvento(${index})">
                                <span>üîç</span>
                                <span>Buscar Nota Millennium</span>
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="verDetalhesEvento(${index})" style="margin-left: 5px;">
                                <span>üìã</span>
                                <span>Ver Detalhes</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function buscarNotaDoEvento(eventIndex) {
            const evento = state.webhookEvents?.[eventIndex];
            if (!evento) {
                showAlert('Evento n√£o encontrado.', 'error');
                return;
            }

            const payload = evento.payload || {};
            const reversaSimulada = {
                id: payload.id,
                ecommerce_number: payload.ecommerce_number,
                status: payload.status,
                client: payload.client || { name: 'Cliente do evento' },
                created_at: payload.created_at || evento.timestamp
            };

            await carregarReversaNoMillennium(eventIndex, reversaSimulada);
        }

        function verDetalhesEvento(eventIndex) {
            const evento = state.webhookEvents?.[eventIndex];
            if (!evento) {
                showAlert('Evento n√£o encontrado.', 'error');
                return;
            }

            // Criar modal com detalhes completos
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            `;

            content.innerHTML = `
                <h3>üì® Detalhes do Evento</h3>
                <p><strong>ID:</strong> ${evento.id}</p>
                <p><strong>Tipo:</strong> ${evento.eventId} - ${evento.eventName}</p>
                <p><strong>Recebido em:</strong> ${formatarDataHora(evento.receivedAt)}</p>
                <hr style="margin: 15px 0;">
                <h4>üì¶ Payload Completo:</h4>
                <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;">${JSON.stringify(evento.payload, null, 2)}</pre>
                <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 15px;" class="btn btn-secondary">Fechar</button>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // Fechar ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Dashboard Functions
        async function refreshDashboard(showNotification = true) {
            try {
                // Buscar eventos recentes
                const backendUrl = getBackendBaseUrl();
                const response = await fetch(`${backendUrl}/api/troquecommerce/webhook-events`);
                const data = await response.json();
                let events = data.events || [];

                // Aplicar filtros do dashboard
                events = applyDashboardFiltersToEvents(events);

                // Atualizar m√©tricas
                updateDashboardMetrics(events);
                
                // Renderizar gr√°ficos
                renderDashboardCharts(events);
                
                // Renderizar tabela de eventos recentes
                renderRecentEventsTable(events);

                // Atualizar timestamp
                state.lastDashboardUpdate = new Date();
                
                if (showNotification) {
                    showAlert('Dashboard atualizado com sucesso!', 'success');
                }
            } catch (error) {
                console.error('Erro ao atualizar dashboard:', error);
                if (showNotification) {
                    showAlert('Erro ao atualizar dashboard: ' + error.message, 'error');
                }
            }
        }

        async function refreshDashboardBackground() {
            // Atualizar apenas se estiver na p√°gina de dashboard
            const dashboardPage = document.getElementById('dashboardPage');
            if (!dashboardPage || !dashboardPage.classList.contains('active')) {
                return;
            }

            await refreshDashboard(false); // N√£o mostrar notifica√ß√£o em background
        }

        function startDashboardAutoUpdate() {
            if (state.dashboardUpdateTimer) {
                clearInterval(state.dashboardUpdateTimer);
            }
            
            // Configurar atualiza√ß√£o autom√°tica a cada 30 segundos
            state.dashboardUpdateTimer = setInterval(refreshDashboardBackground, state.dashboardUpdateInterval);
        }

        function stopDashboardAutoUpdate() {
            if (state.dashboardUpdateTimer) {
                clearInterval(state.dashboardUpdateTimer);
                state.dashboardUpdateTimer = null;
            }
        }

        function applyDashboardFiltersToEvents(events) {
            const filters = state.dashboardFilters;
            let filteredEvents = [...events];

            // Filtro de per√≠odo
            if (filters.period !== 'custom') {
                const days = parseInt(filters.period);
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - days);
                filteredEvents = filteredEvents.filter(e => new Date(e.timestamp) >= startDate);
            } else if (filters.dateStart && filters.dateEnd) {
                const startDate = new Date(filters.dateStart);
                const endDate = new Date(filters.dateEnd);
                endDate.setHours(23, 59, 59, 999);
                filteredEvents = filteredEvents.filter(e => {
                    const eventDate = new Date(e.timestamp);
                    return eventDate >= startDate && eventDate <= endDate;
                });
            }

            // Filtro de tipo de evento
            if (filters.eventType) {
                filteredEvents = filteredEvents.filter(e => e.eventId === filters.eventType);
            }

            // Filtro de status
            if (filters.status) {
                filteredEvents = filteredEvents.filter(e => {
                    const payload = e.payload || {};
                    return payload.status === filters.status;
                });
            }

            // Filtro de n√∫mero do pedido
            if (filters.orderNumber) {
                filteredEvents = filteredEvents.filter(e => {
                    const payload = e.payload || {};
                    return payload.ecommerce_number && 
                           payload.ecommerce_number.toLowerCase().includes(filters.orderNumber.toLowerCase());
                });
            }

            return filteredEvents;
        }

        function applyDashboardFilters() {
            // Atualizar estado dos filtros
            state.dashboardFilters = {
                period: elements.dashboardPeriod.value,
                dateStart: elements.dashboardDateStart.value,
                dateEnd: elements.dashboardDateEnd.value,
                eventType: elements.dashboardEventType.value,
                status: elements.dashboardStatus.value,
                orderNumber: elements.dashboardOrderNumber.value
            };

            // Mostrar/ocultar campos de data personalizados
            const dateRange = document.getElementById('dashboardDateRange');
            const dateRangeEnd = document.getElementById('dashboardDateRangeEnd');
            if (state.dashboardFilters.period === 'custom') {
                dateRange.style.display = 'block';
                dateRangeEnd.style.display = 'block';
            } else {
                dateRange.style.display = 'none';
                dateRangeEnd.style.display = 'none';
            }

            // Atualizar dashboard com filtros
            refreshDashboard();
        }

        function clearDashboardFilters() {
            // Limpar campos
            elements.dashboardPeriod.value = '7';
            elements.dashboardDateStart.value = '';
            elements.dashboardDateEnd.value = '';
            elements.dashboardEventType.value = '';
            elements.dashboardStatus.value = '';
            elements.dashboardOrderNumber.value = '';

            // Ocultar campos de data personalizados
            document.getElementById('dashboardDateRange').style.display = 'none';
            document.getElementById('dashboardDateRangeEnd').style.display = 'none';

            // Limpar estado
            state.dashboardFilters = {
                period: '7',
                dateStart: null,
                dateEnd: null,
                eventType: '',
                status: '',
                orderNumber: ''
            };

            // Atualizar dashboard
            refreshDashboard();
            showAlert('Filtros limpos com sucesso!', 'info');
        }

        function updateDashboardMetrics(events) {
            const last7Days = new Date();
            last7Days.setDate(last7Days.getDate() - 7);
            
            const recentEvents = events.filter(e => new Date(e.timestamp) >= last7Days);
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            // Total de eventos (√∫ltimos 7 dias)
            elements.totalEvents.textContent = recentEvents.length;
            
            // Reversas ativas (baseado nos payloads)
            const activeReversas = recentEvents.filter(e => {
                const payload = e.payload;
                return payload && ['pending', 'in_transit', 'approved'].includes(payload.status);
            });
            elements.activeReversals.textContent = activeReversas.length;
            
            // Conclu√≠das este m√™s
            const completedThisMonth = recentEvents.filter(e => {
                const payload = e.payload;
                const eventDate = new Date(e.timestamp);
                return payload && payload.status === 'finalizado' && 
                       eventDate.getMonth() === currentMonth && eventDate.getFullYear() === currentYear;
            });
            elements.completedReversals.textContent = completedThisMonth.length;
            
            // Valor total em processamento
            const totalValue = activeReversas.reduce((sum, e) => {
                const price = e.payload?.price || 0;
                return sum + price;
            }, 0);
            elements.totalValue.textContent = `R$ ${totalValue.toFixed(2)}`;
        }

        function renderDashboardCharts(events) {
            // Gr√°fico de eventos por tipo
            const eventsByType = {};
            events.forEach(e => {
                eventsByType[e.eventName] = (eventsByType[e.eventName] || 0) + 1;
            });
            
            const typeCanvas = document.getElementById('eventsByTypeChart');
            if (typeCanvas) {
                const ctx = typeCanvas.getContext('2d');
                drawBarChart(ctx, eventsByType, 'Eventos por Tipo');
            }
            
            // Gr√°fico de eventos por dia
            const eventsByDay = {};
            events.forEach(e => {
                const day = new Date(e.timestamp).toLocaleDateString();
                eventsByDay[day] = (eventsByDay[day] || 0) + 1;
            });
            
            const dayCanvas = document.getElementById('eventsByDayChart');
            if (dayCanvas) {
                const ctx = dayCanvas.getContext('2d');
                drawLineChart(ctx, eventsByDay, 'Eventos por Dia');
            }
        }

        function drawBarChart(ctx, data, title) {
            const canvas = ctx.canvas;
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            const labels = Object.keys(data).slice(0, 5); // Limitar a 5 itens
            const values = labels.map(label => data[label]);
            const maxValue = Math.max(...values);
            
            const barWidth = width / (labels.length * 2);
            const barSpacing = barWidth;
            
            labels.forEach((label, i) => {
                const barHeight = (values[i] / maxValue) * (height - 40);
                const x = i * (barWidth + barSpacing) + barSpacing;
                const y = height - barHeight - 20;
                
                ctx.fillStyle = '#3b82f6';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                ctx.fillStyle = '#374151';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(label.substring(0, 10), x + barWidth/2, height - 5);
                ctx.fillText(values[i], x + barWidth/2, y - 5);
            });
        }

        function drawLineChart(ctx, data, title) {
            const canvas = ctx.canvas;
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            const labels = Object.keys(data).slice(-7); // √öltimos 7 dias
            const values = labels.map(label => data[label]);
            const maxValue = Math.max(...values);
            
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            labels.forEach((label, i) => {
                const x = (i / (labels.length - 1)) * (width - 40) + 20;
                const y = height - ((values[i] / maxValue) * (height - 40)) - 20;
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
                
                ctx.fillStyle = '#374151';
                ctx.font = '9px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(values[i], x, y - 5);
            });
            
            ctx.stroke();
        }

        function renderRecentEventsTable(events) {
            const container = elements.recentEventsTable;
            if (!container) return;
            
            const recentEvents = events.slice(0, 10); // √öltimos 10 eventos
            
            if (recentEvents.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Nenhum evento encontrado.</p></div>';
                return;
            }
            
            const tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f9fafb;">
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Data</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Tipo</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Reversa</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentEvents.map(e => `
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${formatarDataHora(e.timestamp)}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${e.eventName}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${e.payload?.ecommerce_number || 'N/A'}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${e.payload?.status || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        // Automa√ß√£o Functions
        function startAutomation() {
            if (state.automationTimer) {
                clearInterval(state.automationTimer);
            }
            
            const config = state.automationConfig;
            if (!config.autoSearchEnabled) {
                showAlert('Habilite a busca autom√°tica nas configura√ß√µes.', 'warning');
                return;
            }
            
            // Executar primeira busca
            performAutoSearch();
            
            // Configurar timer para buscas peri√≥dicas
            state.automationTimer = setInterval(performAutoSearch, config.searchInterval);
            
            // Atualizar UI
            elements.btnStartAutomation.disabled = true;
            elements.btnStopAutomation.disabled = false;
            elements.autoSearchStatusIndicator.textContent = 'Ativa';
            elements.autoSearchStatusIndicator.className = 'status-indicator active';
            
            updateNextSearchTime();
            showAlert('Automa√ß√£o iniciada com sucesso!', 'success');
        }

        function stopAutomation() {
            if (state.automationTimer) {
                clearInterval(state.automationTimer);
                state.automationTimer = null;
            }
            
            // Atualizar UI
            elements.btnStartAutomation.disabled = false;
            elements.btnStopAutomation.disabled = true;
            elements.autoSearchStatusIndicator.textContent = 'Inativa';
            elements.autoSearchStatusIndicator.className = 'status-indicator inactive';
            elements.nextSearchTime.textContent = '‚Äî';
            
            showAlert('Automa√ß√£o parada.', 'info');
        }

        async function performAutoSearch() {
            try {
                const config = state.automationConfig;
                
                // Atualizar estat√≠sticas
                state.automationStats.totalSearches++;
                state.automationStats.lastSearchTime = new Date();
                
                // Buscar reversas com configura√ß√µes autom√°ticas
                const { baseUrl, token } = getTroqueConfig();
                if (!baseUrl || !token) {
                    console.error('Configura√ß√µes da Troquecommerce n√£o encontradas para busca autom√°tica');
                    return;
                }
                
                const backendUrl = getBackendBaseUrl();
                const payload = {
                    baseUrl: normalizarTroqueUrl(baseUrl),
                    token,
                    status: config.autoSearchStatus || undefined,
                    start_date: getDaysAgo(config.autoSearchDays),
                    end_date: new Date().toISOString()
                };
                
                const response = await fetch(`${backendUrl}/api/troquecommerce/order-list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                let reversas = [];
                if (Array.isArray(data?.list)) reversas = data.list;
                
                // Processar automaticamente se habilitado
                if (config.autoProcessEnabled && reversas.length > 0) {
                    await processAutoFoundReversas(reversas);
                }
                
                // Atualizar UI
                updateAutomationStats();
                
                // Notificar se habilitado
                if (config.notificationNewEvents) {
                    showAlert(`${reversas.length} reversa(s) encontrada(s) na busca autom√°tica.`, 'info');
                }
                
            } catch (error) {
                console.error('Erro na busca autom√°tica:', error);
                if (state.automationConfig.notificationErrors) {
                    showAlert(`Erro na busca autom√°tica: ${error.message}`, 'error');
                }
            }
            
            // Atualizar pr√≥xima busca
            updateNextSearchTime();
        }

        async function processAutoFoundReversas(reversas) {
            const config = getConfig();
            let processadas = 0;
            
            for (const reversa of reversas) {
                try {
                    // Verificar se deve processar apenas com nota
                    if (state.automationConfig.autoProcessOnlyWithInvoice) {
                        const numeroNota = reversa?.invoice?.number || reversa?.nota || reversa?.nf;
                        if (!numeroNota) continue;
                    }
                    
                    // Adicionar √† fila de processamento
                    await carregarNotaPorNumero(reversa.invoice?.number, config.vitrine);
                    processadas++;
                } catch (error) {
                    console.error(`Erro ao processar reversa autom√°tica:`, error);
                }
            }
            
            if (processadas > 0) {
                showAlert(`${processadas} nota(s) adicionada(s) automaticamente √† fila.`, 'success');
            }
        }

        function updateAutomationStats() {
            elements.totalSearches.textContent = state.automationStats.totalSearches;
            
            if (state.automationStats.lastSearchTime) {
                elements.lastSearchTime.textContent = formatarDataHora(state.automationStats.lastSearchTime);
            }
        }

        function updateNextSearchTime() {
            if (state.automationTimer && state.automationConfig.autoSearchEnabled) {
                const nextTime = new Date(Date.now() + state.automationConfig.searchInterval);
                elements.nextSearchTime.textContent = formatarDataHora(nextTime);
            }
        }

        function getDaysAgo(days) {
            const date = new Date();
            date.setDate(date.getDate() - days);
            return date.toISOString();
        }

        function saveConfig() {
            // Salvar configura√ß√µes de automa√ß√£o
            state.automationConfig = {
                autoSearchEnabled: elements.autoSearchEnabled.checked,
                searchInterval: parseInt(elements.searchInterval.value),
                autoSearchStatus: elements.autoSearchStatus.value,
                autoSearchDays: parseInt(elements.autoSearchDays.value),
                autoProcessEnabled: elements.autoProcessEnabled.checked,
                autoProcessOnlyWithInvoice: elements.autoProcessOnlyWithInvoice.checked,
                notificationNewEvents: elements.notificationNewEvents.checked,
                notificationErrors: elements.notificationErrors.checked
            };
            
            // Salvar no localStorage
            localStorage.setItem('automationConfig', JSON.stringify(state.automationConfig));
            
            showAlert('Configura√ß√µes salvas com sucesso!', 'success');
        }

        function loadConfig() {
            // Carregar configura√ß√µes do localStorage
            const saved = localStorage.getItem('automationConfig');
            if (saved) {
                state.automationConfig = JSON.parse(saved);
                
                // Atualizar UI
                elements.autoSearchEnabled.checked = state.automationConfig.autoSearchEnabled;
                elements.searchInterval.value = state.automationConfig.searchInterval;
                elements.autoSearchStatus.value = state.automationConfig.autoSearchStatus;
                elements.autoSearchDays.value = state.automationConfig.autoSearchDays;
                elements.autoProcessEnabled.checked = state.automationConfig.autoProcessEnabled;
                elements.autoProcessOnlyWithInvoice.checked = state.automationConfig.autoProcessOnlyWithInvoice;
                elements.notificationNewEvents.checked = state.automationConfig.notificationNewEvents;
                elements.notificationErrors.checked = state.automationConfig.notificationErrors;
            }
        }

        function startScheduleWatcher() {
            if (state.scheduleTimer) {
                clearInterval(state.scheduleTimer);
            }
            // Executar imediatamente e depois a cada 30s
            checkScheduledProcessing();
            state.scheduleTimer = setInterval(checkScheduledProcessing, 30000);
        }

        function resetOneTimeSchedule() {
            elements.scheduleMode.value = 'off';
            updateScheduleFieldsVisibility();
            saveConfigToStorage();
            showAlert('Agendamento √∫nico executado e desativado automaticamente.', 'info');
        }

        function checkScheduledProcessing() {
            const mode = elements.scheduleMode.value;
            if (mode === 'off') return;
            if (state.processando) return;
            if (!hasPendingItems()) return;

            const now = new Date();
            const minutosAtual = now.getHours() * 60 + now.getMinutes();
            const dataKey = now.toISOString().split('T')[0];
            let executionKey = null;

            if (mode === 'daily') {
                executionKey = shouldTriggerDaily(minutosAtual);
                if (executionKey) executionKey = `${mode}-${dataKey}-${executionKey}`;
            } else if (mode === 'weekly') {
                executionKey = shouldTriggerWeekly(minutosAtual, now.getDay());
                if (executionKey) executionKey = `${mode}-${dataKey}-${executionKey}`;
            } else if (mode === 'once') {
                const onceKey = shouldTriggerOnce(now);
                if (onceKey) executionKey = `${mode}-${onceKey}`;
            }

            if (!executionKey) return;
            if (state.ultimoAgendamentoExecutado === executionKey) return;

            state.ultimoAgendamentoExecutado = executionKey;
            showAlert('Processamento autom√°tico da fila iniciado pelo agendamento.', 'info');
            processarFila();

            if (mode === 'once') {
                resetOneTimeSchedule();
            }
        }

        function saveConfigToStorage() {
            try {
                const data = {};
                CONFIG_FIELD_IDS.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (el.type === 'checkbox') {
                        data[id] = el.checked;
                    } else {
                        data[id] = el.value;
                    }
                });
                localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(data));
            } catch (error) {
                console.warn('N√£o foi poss√≠vel salvar configura√ß√µes:', error);
            }
        }

        function loadConfigFromStorage() {
            try {
                const raw = localStorage.getItem(CONFIG_STORAGE_KEY);
                if (!raw) return;
                const data = JSON.parse(raw);
                Object.entries(data).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (!el || value === undefined || value === null) return;
                    if (el.type === 'checkbox') {
                        el.checked = value;
                    } else {
                        el.value = value;
                    }
                });
                updateScheduleFieldsVisibility();
                applyWeeklyDaysToCheckboxes();
            } catch (error) {
                console.warn('N√£o foi poss√≠vel carregar configura√ß√µes:', error);
            }
        }

        function setupConfigPersistence() {
            CONFIG_FIELD_IDS.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const eventName = el.type === 'checkbox' ? 'change' : 'input';
                el.addEventListener(eventName, saveConfigToStorage);
            });

            elements.scheduleMode.addEventListener('change', () => {
                updateScheduleFieldsVisibility();
                saveConfigToStorage();
            });

            elements.scheduleDayCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    updateWeeklyDaysFromCheckboxes();
                    saveConfigToStorage();
                });
            });
        }

        function atualizarResumoNotas() {
            const totalNotas = state.notasFiltradas.length;
            if (totalNotas === 0) {
                elements.notasSummary.style.display = 'none';
                elements.summaryTotalNotas.textContent = '0';
                elements.summaryValorTotal.textContent = 'R$ 0,00';
                elements.summarySelecionadas.textContent = '0';
                return;
            }

            elements.notasSummary.style.display = 'grid';
            elements.summaryTotalNotas.textContent = totalNotas;

            const valorTotal = state.notasFiltradas.reduce((acc, nota) => acc + (parseFloat(nota.valor_final) || 0), 0);
            elements.summaryValorTotal.textContent = formatarValor(valorTotal);

            const selecionadas = document.querySelectorAll('.nota-checkbox:checked').length;
            elements.summarySelecionadas.textContent = selecionadas.toString();
        }

        function aplicarFiltrosNotas() {
            let filtradas = [...state.notasEncontradas];
            const valorMin = parseFloat(elements.valorMin.value);
            const valorMax = parseFloat(elements.valorMax.value);

            if (!isNaN(valorMin)) {
                filtradas = filtradas.filter(nota => (parseFloat(nota.valor_final) || 0) >= valorMin);
            }
            if (!isNaN(valorMax)) {
                filtradas = filtradas.filter(nota => (parseFloat(nota.valor_final) || 0) <= valorMax);
            }

            state.notasFiltradas = filtradas;
            renderListaNotas(state.notasFiltradas);
        }

        function exportarNotasCsv() {
            if (!state.notasFiltradas || state.notasFiltradas.length === 0) {
                showAlert('N√£o h√° notas para exportar', 'error');
                return;
            }

            const headers = ['Nota', 'Sa√≠da', 'Cliente', 'CPF/CNPJ', 'Valor', 'Data'];
            const rows = state.notasFiltradas.map(nota => {
                const cliente = nota.cliente && nota.cliente.length > 0 ? nota.cliente[0] : null;
                return [
                    (nota.nf || nota.nota || '').replace(/;/g, ''),
                    (nota.saida || '').toString().replace(/;/g, ''),
                    (cliente?.nome || nota.nome_cliente || '').replace(/;/g, ''),
                    (cliente?.cpf || cliente?.cnpj || '').replace(/;/g, ''),
                    (parseFloat(nota.valor_final) || 0).toFixed(2).replace('.', ','),
                    formatarData(nota.data_hora_emissao)
                ];
            });

            const csvContent = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const fileName = `notas_${elements.dataInicial.value || 'inicio'}_${elements.dataFinal.value || 'fim'}.csv`;
            link.href = url;
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(url);
            showAlert('Arquivo CSV exportado com sucesso!', 'success');
        }

        function obterNumeroNota(pedido) {
            return pedido?.nf || pedido?.NF || pedido?.nota || pedido?.NOTA || pedido?.NumeroNota;
        }

        function buildPedidoVendaRequestBody({ dataInicial, dataFinal, numeroPedidoCliente, codPedidoMktPlace, opcaoData = 1 } = {}) {
            const defaultStart = dataInicial || '1900-01-01T00:00:00.000Z';
            const defaultEnd = dataFinal || '2100-12-31T23:59:59.999Z';

            return {
                SCRIPTFILIAL: null,
                DATAI: defaultStart,
                DATAF: defaultEnd,
                TIPO: "AC",
                BLOQUEIOS: null,
                CIDADE: null,
                CLIENTE: null,
                CLIENTE_ENTREGA: null,
                CLI_GRUPO_LOJA: null,
                COD_PEDIDOV: "",
                COD_PEDIDO_MKT_PLACE: codPedidoMktPlace || null,
                COLECAO_PEDIDO: null,
                COLECAO_PRODUTO: null,
                COMANDA: null,
                CONSIGNACAO: null,
                COR: null,
                EFETUADO: 2,
                ENDERECO_RETIRADA: null,
                ENTREGA_IMEDIATA: null,
                ESTADO: null,
                ESTAMPA: null,
                FILTROPRO: true,
                GRUPO_LOJA: null,
                GRUPO_PRODUTO: null,
                IGNORA_PARAM: false,
                LISTA_CASAMENTO: false,
                N_PEDIDO_CLIENTE: numeroPedidoCliente || "",
                OPCAO_DATA: opcaoData,
                ORCAMENTO: null,
                ORDEM: 0,
                ORIGEM_PEDIDO: null,
                PEDIDOV: null,
                PONTO_RETIRADA: null,
                PRESENTE: null,
                PRODUTO: null,
                SCRIPTREPRESENTANTE: null,
                SCRIPTVENDEDOR: null,
                STATUS_WORKFLOW: null,
                SUSPENSO: null,
                TABELA: null,
                TAMANHO: null,
                TIPO_PEDIDO: null,
                TRANSPORTADORA: null
            };
        }

        async function consultarPedidosMillennium(filtros = {}) {
            const config = getConfig();
            const body = buildPedidoVendaRequestBody(filtros);
            const url = `${config.baseUrl}/api/millenium.PEDIDO_VENDA.Lista_Data?$format=json`;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': getAuthHeader(),
                    'Content-Type': 'application/json',
                    'x-http-method': 'GET',
                    'x-dateformat': 'ISOTZ',
                    'x-identifiercase': 'upper'
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            return Array.isArray(data) ? data : (data.value || []);
        }

        function getConfig() {
            return {
                baseUrl: document.getElementById('baseUrl').value.trim(),
                username: document.getElementById('username').value.trim(),
                password: document.getElementById('password').value.trim(),
                vitrine: parseInt(document.getElementById('vitrine').value),
                faturar: document.getElementById('faturar').value,
                autorizarNfe: document.getElementById('autorizarNfe').value,
                tipoAutorizacaoTroca: parseInt(document.getElementById('tipoAutorizacaoTroca').value),
                tipoPgtoCredito: parseInt(document.getElementById('tipoPgtoCredito').value),
                trocaValorBruto: document.getElementById('trocaValorBruto').value
            };
        }

        function getAuthHeader() {
            const config = getConfig();
            const token = btoa(`${config.username}:${config.password}`);
            return `Basic ${token}`;
        }

        // Alternar entre modos de busca
        function alternarModo(modo) {
            const isNota = modo === 'nota';
            const isPeriodo = modo === 'periodo';
            const isPedido = modo === 'pedido';

            elements.buscaNotaSection.style.display = isNota ? 'block' : 'none';
            elements.buscaPeriodoSection.classList.toggle('active', isPeriodo);
            elements.buscaPedidoSection.classList.toggle('active', isPedido);

            elements.btnModoNota.style.opacity = isNota ? '1' : '0.6';
            elements.btnModoPeriodo.style.opacity = isPeriodo ? '1' : '0.6';
            elements.btnModoPedido.style.opacity = isPedido ? '1' : '0.6';
        }

        // Formatar data para exibi√ß√£o
        function formatarData(dataString) {
            if (!dataString) return 'N/A';
            const match = dataString.match(/\/Date\((\d+)([+-]\d+)?\)\//)
            if (match) {
                const timestamp = parseInt(match[1], 10);
                return new Date(timestamp).toLocaleDateString('pt-BR');
            }
            return new Date(dataString).toLocaleDateString('pt-BR');
        }

        // Formatar valor monet√°rio
        function formatarValor(valor) {
            if (!valor) return 'R$ 0,00';
            return `R$ ${valor.toFixed(2).replace('.', ',')}`;
        }

        // Obter n√∫meros de WhatsApp configurados
        function getWhatsAppNumeros() {
            const numeros = [];
            const fixo = document.getElementById('whatsappFixo').value.trim();
            const adicionais = document.getElementById('whatsappAdicionais').value.trim();
            
            if (fixo) numeros.push(fixo);
            if (adicionais) {
                adicionais.split(',').forEach(num => {
                    const limpo = num.trim().replace(/\D/g, '');
                    if (limpo) numeros.push(limpo);
                });
            }
            
            return numeros;
        }

        // Enviar mensagem via WhatsApp Web
        function enviarWhatsApp(numero, mensagem) {
            const enviarRelatorios = document.getElementById('enviarRelatorios').checked;
            if (!enviarRelatorios) return;
            
            const mensagemEncoded = encodeURIComponent(mensagem);
            const url = `https://wa.me/${numero}?text=${mensagemEncoded}`;
            window.open(url, '_blank');
        }

        // Enviar para todos os n√∫meros configurados
        function enviarWhatsAppParaTodos(mensagem) {
            const numeros = getWhatsAppNumeros();
            numeros.forEach((numero, index) => {
                setTimeout(() => {
                    enviarWhatsApp(numero, mensagem);
                }, index * 1000); // Delay de 1s entre cada envio
            });
        }

        // Gerar relat√≥rio de notas listadas
        function gerarRelatorioNotas(notas, dataInicial, dataFinal) {
            const dataInicialFormatada = new Date(dataInicial).toLocaleDateString('pt-BR');
            const dataFinalFormatada = new Date(dataFinal).toLocaleDateString('pt-BR');
            
            let mensagem = `üîÑ RELAT√ìRIO DE TROCAS/DEVOLU√á√ïES\n\n`;
            mensagem += `üìÖ Per√≠odo: ${dataInicialFormatada} a ${dataFinalFormatada}\n`;
            mensagem += `üìä Total de notas: ${notas.length}`;
            
            return mensagem;
        }

        async function obterNotasPorPeriodo(startDateISO, endDateISO) {
            const config = getConfig();
            const body = buildPedidoVendaRequestBody({
                dataInicial: startDateISO,
                dataFinal: endDateISO,
                opcaoData: 1
            });

            const url = `${config.baseUrl}/api/millenium.PEDIDO_VENDA.Lista_Data?$format=json`;
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': getAuthHeader(),
                    'Content-Type': 'application/json',
                    'x-http-method': 'GET',
                    'x-dateformat': 'ISOTZ',
                    'x-identifiercase': 'upper'
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            const pedidos = Array.isArray(data) ? data : (data.value || []);

            if (pedidos.length === 0) {
                return [];
            }

            const notasComDetalhes = [];
            for (const pedido of pedidos.slice(0, MAX_NOTAS_PROCESSADAS)) {
                const numeroNF = obterNumeroNota(pedido);
                if (!numeroNF || numeroNF === '0') {
                    const clienteInfo = (pedido.CLIENTE && pedido.CLIENTE[0]) || (pedido.cliente && pedido.cliente[0]) || null;
                    const produtosPedido = pedido.PRODUTOS || pedido.produtos || pedido.ITENS || pedido.itens || [];
                    notasComDetalhes.push({
                        semNota: true,
                        n_pedido_cliente: pedido.N_PEDIDO_CLIENTE || pedido.n_pedido_cliente,
                        data_hora_emissao: pedido.DATA || pedido.data,
                        saida: pedido.SAIDA || pedido.saida,
                        valor_final: pedido.VALOR_FINAL || pedido.valor_final,
                        nome_cliente: pedido.NOME_CLIENTE || pedido.nome_cliente || clienteInfo?.NOME || clienteInfo?.nome || 'N/A',
                        cliente: clienteInfo,
                        produtos: produtosPedido
                    });
                    continue;
                }

                try {
                    const notaUrl = `${config.baseUrl}/api/MILLENIUM_ECO.pedido_venda/listafaturamentos?vitrine=${config.vitrine}&nota=${numeroNF}&$format=json`;
                    const notaResponse = await fetch(notaUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': getAuthHeader(),
                            'Content-Type': 'application/json'
                        }
                    });

                    if (notaResponse.ok) {
                        const notaData = await notaResponse.json();
                        if (notaData.value && notaData.value.length > 0) {
                            notasComDetalhes.push(notaData.value[0]);
                        }
                    }
                } catch (err) {
                    console.warn(`Erro ao buscar nota ${numeroNF}:`, err);
                }
            }

            return notasComDetalhes;
        }

        // Listar notas por per√≠odo
        async function listarNotasPorPeriodo() {
            const dataInicial = elements.dataInicial.value;
            const dataFinal = elements.dataFinal.value;

            if (!dataInicial || !dataFinal) {
                showAlert('Por favor, informe as datas inicial e final', 'error');
                return;
            }

            const config = getConfig();
            elements.btnListarNotas.disabled = true;
            elements.btnListarNotas.innerHTML = '<span class="loading"></span> Listando...';

            try {
                const startDateISO = new Date(dataInicial + 'T00:00:00.000Z').toISOString();
                const endDateISO = new Date(dataFinal + 'T23:59:59.999Z').toISOString();

                const notasComDetalhes = await obterNotasPorPeriodo(startDateISO, endDateISO);

                state.notasEncontradas = notasComDetalhes;
                aplicarFiltrosNotas();
                showAlert(`${state.notasFiltradas.length} nota(s) encontrada(s) no per√≠odo`, 'success');

                const relatorio = gerarRelatorioNotas(state.notasFiltradas, dataInicial, dataFinal);
                enviarWhatsAppParaTodos(relatorio);

            } catch (error) {
                console.error('Erro ao listar notas:', error);
                showAlert(`Erro ao listar notas: ${error.message}`, 'error');
                elements.notasListContainer.innerHTML = '';
            } finally {
                elements.btnListarNotas.disabled = false;
                elements.btnListarNotas.innerHTML = '<span>üìã</span><span>Listar Notas do Per√≠odo</span>';
            }
        }

        // Buscar pedido por n√∫mero do cliente
        async function buscarPedido() {
            const numeroPedido = elements.numeroPedido.value.trim();
            if (!numeroPedido) {
                showAlert('Por favor, informe o n√∫mero do pedido', 'error');
                return;
            }

            const config = getConfig();
            elements.btnBuscarPedido.disabled = true;
            elements.btnBuscarPedido.innerHTML = '<span class="loading"></span> Buscando...';

            try {
                let pedidos = await consultarPedidosMillennium({ numeroPedidoCliente: numeroPedido });
                let origemBusca = 'n√∫mero do pedido';

                if (pedidos.length === 0) {
                    pedidos = await consultarPedidosMillennium({ codPedidoMktPlace: numeroPedido });
                    origemBusca = 'c√≥digo marketplace';
                }

                if (pedidos.length === 0) {
                    throw new Error('Pedido n√£o encontrado');
                }

                const pedido = pedidos[0];
                const numeroNota = obterNumeroNota(pedido);

                if (!numeroNota || numeroNota === '0') {
                    exibirPedidoSemNota(pedido, origemBusca);
                    throw new Error(`Pedido encontrado via ${origemBusca}, mas a nota fiscal ainda n√£o est√° dispon√≠vel`);
                }

                esconderPedidoSemNota();
                await carregarNotaPorNumero(numeroNota, config.vitrine);
                showAlert(`Pedido ${numeroPedido} (${origemBusca}) carregado com a nota ${numeroNota}`, 'success');

            } catch (error) {
                console.error('Erro ao buscar pedido:', error);
                showAlert(`Erro ao buscar pedido: ${error.message}`, 'error');
            } finally {
                elements.btnBuscarPedido.disabled = false;
                elements.btnBuscarPedido.innerHTML = '<span>üì¶</span><span>Buscar Pedido</span>';
            }
        }

        function exibirPedidoSemNota(pedido, origem) {
            if (!pedido) return;
            const clientePadrao = pedido.cliente || pedido.CLIENTE || [];
            const clienteInfo = Array.isArray(clientePadrao) ? (clientePadrao[0] || {}) : clientePadrao;
            const nomeCliente = clienteInfo.NOME || clienteInfo.nome || pedido.NOME_CLIENTE || pedido.nome_cliente || 'N/A';
            const cpfCliente = clienteInfo.CPF || clienteInfo.cpf || pedido.CPF || pedido.cpf || 'N/A';
            const dataPedido = pedido.DATA || pedido.data || pedido.data_hora_emissao;
            const codigoSaida = pedido.SAIDA || pedido.saida || '‚Äî';
            const valor = pedido.VALOR_FINAL || pedido.valor_final || pedido.total || 0;
            const produtos = pedido.produtos || pedido.PRODUTOS || pedido.ITENS || pedido.itens || [];

            const produtosHtml = produtos && produtos.length
                ? `<div style="margin-top:15px;"><strong>Produtos (${produtos.length}):</strong><ul style="margin-top:5px; padding-left:18px; color:#7c2d12;">${produtos.map((p, idx) => `<li><strong>${p.desc_produto || p.DESCRICAO || 'Item ' + (idx+1)}</strong> - Qtde: ${p.quantidade || p.QUANTIDADE || 1} | SKU: ${p.sku || p.SKU || p.PRODUTO || ''}</li>`).join('')}</ul></div>`
                : '<p style="margin-top:10px;">Itens n√£o dispon√≠veis nesta consulta.</p>';

            elements.pedidoSemNotaContainer.innerHTML = `
                <div style="text-align: left; color: #7c2d12;">
                    <p style="font-weight: 600;">Pedido ${pedido.N_PEDIDO_CLIENTE || pedido.n_pedido_cliente || 'N/A'} (${origem})</p>
                    <p><strong>Cliente:</strong> ${nomeCliente} | CPF/CNPJ: ${cpfCliente}</p>
                    <p><strong>Data:</strong> ${dataPedido ? formatarData(dataPedido) : 'N/A'}</p>
                    <p><strong>Sa√≠da:</strong> ${codigoSaida}</p>
                    <p><strong>Valor Previsto:</strong> ${formatarValor(valor)}</p>
                    ${produtosHtml}
                    <p style="margin-top: 10px;">Aguardando faturamento para liberar a nota fiscal.</p>
                </div>
            `;
            elements.pedidoSemNotaCard.style.display = 'block';
        }

        function esconderPedidoSemNota() {
            elements.pedidoSemNotaCard.style.display = 'none';
            elements.pedidoSemNotaContainer.innerHTML = '';
        }

        // Buscar nota fiscal
        async function buscarNota() {
            const numeroNota = elements.numeroNota.value.trim();
            const config = getConfig();

            elements.btnBuscar.disabled = true;
            elements.btnBuscar.innerHTML = '<span class="loading"></span> Buscando...';

            try {
                if (numeroNota) {
                    const url = `${config.baseUrl}/api/MILLENIUM_ECO.pedido_venda/listafaturamentos?vitrine=${config.vitrine}&nota=${numeroNota}&$format=json`;
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': getAuthHeader(),
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (!data.value || data.value.length === 0) {
                        throw new Error('Nota fiscal n√£o encontrada');
                    }

                    state.notaAtual = data.value[0];
                    renderNotaInfo();
                    renderProdutos();
                    showAlert('Nota fiscal carregada com sucesso!', 'success');
                } else {
                    const dataInicial = elements.notaDataInicial.value;
                    const dataFinal = elements.notaDataFinal.value;

                    if (!dataInicial || !dataFinal) {
                        throw new Error('Informe as datas inicial e final para buscar notas faturadas');
                    }

                    const startDateISO = new Date(dataInicial + 'T00:00:00.000Z').toISOString();
                    const endDateISO = new Date(dataFinal + 'T23:59:59.999Z').toISOString();

                    const notasComDetalhes = await obterNotasPorPeriodo(startDateISO, endDateISO);

                    if (notasComDetalhes.length === 0) {
                        throw new Error('Nenhuma nota encontrada no per√≠odo informado');
                    }

                    state.notasEncontradas = notasComDetalhes;
                    aplicarFiltrosNotas();
                    const notaDisponivel = notasComDetalhes.find(nota => !nota.semNota);

                    if (notaDisponivel) {
                        state.notaAtual = notaDisponivel;
                        renderNotaInfo();
                        renderProdutos();
                        esconderPedidoSemNota();
                        showAlert(`Nota ${notaDisponivel.nf || notaDisponivel.nota} carregada automaticamente!`, 'success');
                    } else {
                        state.notaAtual = null;
                        const pedidoSemNota = notasComDetalhes.find(nota => nota.semNota);
                        if (pedidoSemNota) {
                            exibirPedidoSemNota(pedidoSemNota, 'busca por per√≠odo');
                        }
                        elements.notaInfoContainer.innerHTML = '<div class="empty-state"><p>Pedidos encontrados, mas nenhuma nota fiscal foi emitida ainda.</p></div>';
                        elements.produtosContainer.innerHTML = '<div class="empty-state"><p>Nenhum produto dispon√≠vel</p></div>';
                        showAlert('Pedidos encontrados ainda sem nota fiscal emitida. Aguarde o faturamento.', 'info');
                    }
                }
            } catch (error) {
                console.error('Erro ao buscar nota:', error);
                showAlert(`Erro ao buscar nota: ${error.message}`, 'error');
                state.notaAtual = null;
                elements.notaInfoContainer.innerHTML = '<div class="empty-state"><p>Erro ao carregar nota fiscal</p></div>';
                elements.produtosContainer.innerHTML = '<div class="empty-state"><p>Nenhum produto dispon√≠vel</p></div>';
            } finally {
                elements.btnBuscar.disabled = false;
                elements.btnBuscar.innerHTML = '<span>üîç</span><span>Buscar Nota</span>';
            }
        }
        // Renderizar lista de notas
        function renderListaNotas(notas) {
            if (!notas || notas.length === 0) {
                elements.notasListContainer.innerHTML = '<div class="empty-state" style="padding: 20px;"><p>Nenhuma nota encontrada no per√≠odo</p></div>';
                elements.notasActionsContainer.style.display = 'none';
                elements.notasSummary.style.display = 'none';
                return;
            }

            console.log('Renderizando notas:', notas);

            elements.notasListContainer.innerHTML = notas.map((nota, index) => {
                const semNota = Boolean(nota.semNota);
                const numeroNotaRaw = nota.nota || nota.nf || nota.NF || nota.NumeroNota;
                const numeroNota = semNota ? '' : (numeroNotaRaw || 'N/A');
                const vitrine = nota.vitrine || 101;
                const clienteNome = nota.nome_cliente || nota.nomeCliente || 'N/A';
                const badgeTexto = semNota ? 'Pedido sem nota' : formatarValor(nota.valor_final);

                return `
                    <div class="nota-list-item ${semNota ? 'sem-nota' : ''}" data-nota="${numeroNota}" data-vitrine="${vitrine}" data-index="${index}" data-sem-nota="${semNota}">
                        <input type="checkbox" class="nota-checkbox" data-nota-index="${index}" ${semNota ? 'disabled' : ''}>
                        <div class="nota-content">
                            <div class="nota-list-header">
                                <div class="nota-list-title">${semNota ? `Pedido ${nota.n_pedido_cliente || 'N/A'}` : `Nota #${numeroNota}`}</div>
                                <div class="nota-list-badge">${badgeTexto}</div>
                            </div>
                            <div class="nota-list-details">
                                <strong>Cliente:</strong> ${clienteNome}<br>
                                <strong>Data:</strong> ${formatarData(nota.data_hora_emissao)}<br>
                                <strong>Sa√≠da:</strong> ${nota.saida || 'N/A'}${semNota ? ' | <span style="color:#b45309;">Nota ainda n√£o emitida</span>' : ` | <strong>Produtos:</strong> ${nota.produtos?.length || 0}`}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Mostrar bot√µes de a√ß√£o
            document.getElementById('notasActionsContainer').style.display = 'flex';
            elements.notasSummary.style.display = 'grid';

            // Event listeners para selecionar nota (clique no conte√∫do, n√£o no checkbox)
            document.querySelectorAll('.nota-content').forEach((content, index) => {
                content.addEventListener('click', async () => {
                    const item = content.closest('.nota-list-item');
                    const semNota = item.dataset.semNota === 'true';
                    if (semNota) {
                        showAlert('Este pedido ainda n√£o possui nota fiscal liberada.', 'info');
                        return;
                    }
                    const numeroNota = item.dataset.nota;
                    const vitrine = item.dataset.vitrine;
                    
                    // Remover sele√ß√£o anterior
                    document.querySelectorAll('.nota-list-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    
                    // Carregar nota
                    await carregarNotaPorNumero(numeroNota, vitrine);
                });
            });
            
            // Prevenir que clique no checkbox dispare o carregamento
            document.querySelectorAll('.nota-checkbox').forEach(checkbox => {
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                if (checkbox.closest('.nota-list-item')?.dataset.semNota === 'true') {
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    return;
                }
                checkbox.addEventListener('change', atualizarResumoNotas);
            });

            atualizarResumoNotas();
        }

        // Selecionar todas as notas
        function selecionarTodasNotas() {
            document.querySelectorAll('.nota-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            atualizarResumoNotas();
        }

        // Desselecionar todas as notas
        function deselecionarTodasNotas() {
            document.querySelectorAll('.nota-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            atualizarResumoNotas();
        }

        // Carregar notas selecionadas
        async function carregarNotasSelecionadas() {
            const checkboxes = document.querySelectorAll('.nota-checkbox:checked');
            
            if (checkboxes.length === 0) {
                showAlert('Selecione pelo menos uma nota', 'error');
                return;
            }
            
            showAlert(`Carregando ${checkboxes.length} nota(s) selecionada(s)...`, 'info');
            
            let sucessos = 0;
            let erros = 0;
            
            for (const checkbox of checkboxes) {
                const item = checkbox.closest('.nota-list-item');
                const numeroNota = item.dataset.nota;
                const vitrine = item.dataset.vitrine;
                
                try {
                    await carregarNotaPorNumero(numeroNota, vitrine);
                    sucessos++;
                } catch (error) {
                    console.error(`Erro ao carregar nota ${numeroNota}:`, error);
                    erros++;
                }
            }
            
            showAlert(`${sucessos} nota(s) carregada(s) com sucesso! ${erros > 0 ? `${erros} erro(s).` : ''}`, sucessos > 0 ? 'success' : 'error');
        }

        // Carregar nota por n√∫mero
        async function carregarNotaPorNumero(numeroNota, vitrine) {
            console.log('Carregando nota:', numeroNota, 'vitrine:', vitrine);
            
            if (!numeroNota || numeroNota === 'undefined' || numeroNota === 'N/A') {
                showAlert('N√∫mero da nota inv√°lido', 'error');
                return;
            }
            
            const config = getConfig();
            
            try {
                const url = `${config.baseUrl}/api/MILLENIUM_ECO.pedido_venda/listafaturamentos?vitrine=${vitrine || config.vitrine}&nota=${numeroNota}&$format=json`;
                console.log('URL da requisi√ß√£o:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': getAuthHeader(),
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.value || data.value.length === 0) {
                    throw new Error('Nota fiscal n√£o encontrada');
                }

                state.notaAtual = data.value[0];
                renderNotaInfo();
                renderProdutos();
                showAlert('Nota fiscal carregada com sucesso!', 'success');

            } catch (error) {
                console.error('Erro ao carregar nota:', error);
                showAlert(`Erro ao carregar nota: ${error.message}`, 'error');
            }
        }

        // Renderizar informa√ß√µes da nota
        function renderNotaInfo() {
            if (!state.notaAtual) return;

            const nota = state.notaAtual;
            
            // Extrair dados do cliente (primeiro item do array)
            const cliente = nota.cliente && nota.cliente.length > 0 ? nota.cliente[0] : null;
            const nomeCliente = cliente?.nome || 'N/A';
            const cpfCliente = cliente?.cpf || cliente?.cnpj || 'N/A';
            
            elements.notaInfoContainer.innerHTML = `
                <div class="nota-info">
                    <h3 style="margin-bottom: 15px; color: #111827;">Informa√ß√µes da Nota</h3>
                    <div class="nota-info-grid">
                        <div class="nota-info-item">
                            <label>Nota Fiscal</label>
                            <span>${nota.nf || nota.nota || 'N/A'}</span>
                        </div>
                        <div class="nota-info-item">
                            <label>Sa√≠da (PEDIDOV)</label>
                            <span>${nota.saida}</span>
                        </div>
                        <div class="nota-info-item">
                            <label>Cliente</label>
                            <span>${nomeCliente}</span>
                        </div>
                        <div class="nota-info-item">
                            <label>CPF/CNPJ</label>
                            <span>${cpfCliente}</span>
                        </div>
                        <div class="nota-info-item">
                            <label>C√≥digo Endere√ßo</label>
                            <span>${nota.cod_endereco || 'N/A'}</span>
                        </div>
                        <div class="nota-info-item">
                            <label>Valor Total</label>
                            <span>R$ ${nota.valor_final?.toFixed(2) || '0.00'}</span>
                        </div>
                        <div class="nota-info-item">
                            <label>Status NF-e</label>
                            <span>${nota.mensagem_nfe || 'N/A'}</span>
                        </div>
                        <div class="nota-info-item">
                            <label>Pedido Cliente</label>
                            <span>${nota.n_pedido_cliente || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Renderizar produtos
        function renderProdutos() {
            if (!state.notaAtual || !state.notaAtual.produtos) {
                elements.produtosContainer.innerHTML = '<div class="empty-state"><p>Nenhum produto dispon√≠vel</p></div>';
                return;
            }

            const produtos = state.notaAtual.produtos;
            elements.produtosContainer.innerHTML = `
                <div class="produtos-list scrollbar">
                    ${produtos.map((produto, index) => `
                        <div class="produto-item" data-index="${index}">
                            <div class="produto-header">
                                <input type="checkbox" class="produto-checkbox" data-index="${index}">
                                <div class="produto-info">
                                    <div class="produto-nome">${produto.desc_produto || 'Produto'}</div>
                                    <div class="produto-detalhes">
                                        C√≥digo de Barras: ${produto.barra} | 
                                        Tamanho: ${produto.tamanho || 'N/A'} | 
                                        Cor: ${produto.cor || 'N/A'}
                                    </div>
                                </div>
                                <div class="produto-preco">R$ ${produto.preco?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div class="produto-quantidade">
                                <label style="font-size: 12px; color: #6b7280;">Quantidade a trocar/devolver:</label>
                                <input type="number" 
                                       class="produto-qtd-input" 
                                       data-index="${index}" 
                                       min="1" 
                                       max="${produto.quantidade}" 
                                       value="1"
                                       disabled>
                                <span style="font-size: 12px; color: #6b7280;">de ${produto.quantidade}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Event listeners para checkboxes
            document.querySelectorAll('.produto-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const item = document.querySelector(`.produto-item[data-index="${index}"]`);
                    const qtdInput = document.querySelector(`.produto-qtd-input[data-index="${index}"]`);
                    
                    if (e.target.checked) {
                        item.classList.add('selected');
                        qtdInput.disabled = false;
                    } else {
                        item.classList.remove('selected');
                        qtdInput.disabled = true;
                    }
                    
                    updateBtnAdicionarFila();
                });
            });

            updateBtnAdicionarFila();
        }

        // Atualizar bot√£o de adicionar √† fila
        function updateBtnAdicionarFila() {
            const checkboxes = document.querySelectorAll('.produto-checkbox:checked');
            elements.btnAdicionarFila.disabled = checkboxes.length === 0;
        }

        // Adicionar √† fila
        function adicionarFila() {
            const checkboxes = document.querySelectorAll('.produto-checkbox:checked');
            if (checkboxes.length === 0) return;

            const config = getConfig();
            
            // Validar campo obrigat√≥rio
            if (!config.tipoPgtoCredito || config.tipoPgtoCredito === '') {
                showAlert('Por favor, preencha o campo "Tipo Pgto Cr√©dito" antes de adicionar √† fila', 'error');
                document.getElementById('tipoPgtoCredito').focus();
                return;
            }
            
            const produtosSelecionados = [];

            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                const produto = state.notaAtual.produtos[index];
                const qtdInput = document.querySelector(`.produto-qtd-input[data-index="${index}"]`);
                const quantidade = parseFloat(qtdInput.value);

                produtosSelecionados.push({
                    quantidade: quantidade,
                    preco: produto.preco,
                    barra: produto.barra
                });
            });

            const numeroNota = obterNumeroNota(state.notaAtual);

            const body = {
                vitrine: config.vitrine,
                faturar: 'T',
                autorizar_nfe: config.autorizarNfe,
                tipo_autorizacao_troca: config.tipoAutorizacaoTroca,
                produtos: produtosSelecionados,
                nota: numeroNota,
                saida: state.notaAtual.saida,
                cod_endereco: state.notaAtual.cod_endereco,
                tipo_pgto_credito: config.tipoPgtoCredito,
                troca_pelo_valor_bruto: config.trocaValorBruto
            };

            const filaItem = {
                id: Date.now(),
                nota: numeroNota,
                saida: state.notaAtual.saida,
                produtos: produtosSelecionados.length,
                body: body,
                status: 'pending',
                timestamp: new Date().toISOString(),
                response: null,
                error: null
            };

            state.fila.push(filaItem);
            renderFila();
            updateStats();
            showAlert(`Troca/devolu√ß√£o adicionada √† fila! (${produtosSelecionados.length} produto(s))`, 'success');

            // Limpar sele√ß√£o
            document.querySelectorAll('.produto-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.produto-item').forEach(item => item.classList.remove('selected'));
            document.querySelectorAll('.produto-qtd-input').forEach(input => input.disabled = true);
            updateBtnAdicionarFila();
        }

        // Renderizar fila
        function renderFila() {
            if (state.fila.length === 0) {
                elements.filaList.innerHTML = '<div class="empty-state"><p>Nenhuma troca/devolu√ß√£o na fila</p></div>';
                elements.btnProcessarFila.disabled = true;
                return;
            }

            elements.filaList.innerHTML = state.fila.map(item => `
                <div class="fila-item">
                    <div class="fila-item-header">
                        <div class="fila-item-title">
                            Nota ${item.nota} | Sa√≠da ${item.saida} | ${item.produtos} produto(s)
                        </div>
                        <span class="status-badge status-${item.status}">
                            ${item.status === 'pending' ? '‚è≥ Pendente' : 
                              item.status === 'processing' ? '‚öôÔ∏è Processando' :
                              item.status === 'success' ? '‚úÖ Sucesso' :
                              '‚ùå Erro'}
                        </span>
                    </div>
                    <div class="fila-item-body">
                        <div style="margin-bottom: 10px;">
                            <strong>Timestamp:</strong> ${new Date(item.timestamp).toLocaleString('pt-BR')}
                        </div>
                        ${item.error ? `
                            <div style="color: #991b1b; margin-bottom: 10px;">
                                <strong>Erro:</strong> ${item.error}
                            </div>
                        ` : ''}
                        ${item.response ? `
                            <div style="margin-bottom: 10px;">
                                <strong>Response:</strong>
                                <pre>${JSON.stringify(item.response, null, 2)}</pre>
                            </div>
                        ` : ''}
                        <details>
                            <summary style="cursor: pointer; color: #667eea; font-weight: 600;">Ver Body da Requisi√ß√£o</summary>
                            <pre>${JSON.stringify(item.body, null, 2)}</pre>
                        </details>
                    </div>
                </div>
            `).join('');

            const hasPending = state.fila.some(item => item.status === 'pending');
            elements.btnProcessarFila.disabled = !hasPending || state.processando;
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            const total = state.fila.length;
            const pending = state.fila.filter(item => item.status === 'pending').length;
            const success = state.fila.filter(item => item.status === 'success').length;
            const error = state.fila.filter(item => item.status === 'error').length;

            elements.statTotal.textContent = total;
            elements.statPending.textContent = pending;
            elements.statSuccess.textContent = success;
            elements.statError.textContent = error;
        }

        // Processar fila
        async function processarFila() {
            if (state.processando) return;

            state.processando = true;
            elements.btnProcessarFila.disabled = true;
            elements.btnProcessarFila.innerHTML = '<span class="loading"></span> Processando...';

            // Contar itens pendentes
            const itensPendentes = state.fila.filter(item => item.status === 'pending').length;
            
            // Enviar mensagem de in√≠cio via WhatsApp
            let mensagemInicio = `‚ñ∂Ô∏è PROCESSAMENTO INICIADO\n\n`;
            mensagemInicio += `üìã Total de notas na fila: ${itensPendentes}\n`;
            mensagemInicio += `‚è≥ Aguarde o processamento...`;
            enviarWhatsAppParaTodos(mensagemInicio);

            const config = getConfig();
            const url = `${config.baseUrl}/api/MILLENIUM_ECO.troca_devolucao/inclui`;

            for (const item of state.fila) {
                if (item.status !== 'pending') continue;

                item.status = 'processing';
                renderFila();
                updateStats();

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': getAuthHeader(),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(item.body)
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${JSON.stringify(data)}`);
                    }

                    item.status = 'success';
                    item.response = data;
                    showAlert(`Troca/devolu√ß√£o processada com sucesso! (Nota ${item.nota})`, 'success');

                } catch (error) {
                    console.error('Erro ao processar item:', error);
                    item.status = 'error';
                    item.error = error.message;
                    showAlert(`Erro ao processar nota ${item.nota}: ${error.message}`, 'error');
                }

                renderFila();
                updateStats();
            }

            state.processando = false;
            elements.btnProcessarFila.innerHTML = '<span>‚ñ∂Ô∏è</span><span>Processar Fila</span>';
            showAlert('Processamento da fila conclu√≠do!', 'info');
            
            // Enviar mensagem de finaliza√ß√£o via WhatsApp
            const stats = {
                total: state.fila.length,
                pending: state.fila.filter(item => item.status === 'pending').length,
                success: state.fila.filter(item => item.status === 'success').length,
                error: state.fila.filter(item => item.status === 'error').length
            };
            
            let mensagemFim = `‚úÖ PROCESSAMENTO CONCLU√çDO\n\n`;
            mensagemFim += `üìä Estat√≠sticas:\n`;
            mensagemFim += `- Total: ${stats.total}\n`;
            mensagemFim += `- Pendentes: ${stats.pending}\n`;
            mensagemFim += `- Sucesso: ${stats.success} ‚úÖ\n`;
            mensagemFim += `- Erros: ${stats.error} ‚ùå\n\n`;
            
            if (stats.success > 0) {
                mensagemFim += `üéâ ${stats.success} troca(s)/devolu√ß√£o(√µes) processada(s) com sucesso!`;
            }
            if (stats.error > 0) {
                if (stats.success > 0) mensagemFim += `\n`;
                mensagemFim += `‚ö†Ô∏è ${stats.error} troca(s)/devolu√ß√£o(√µes) com erro.`;
            }
            
            enviarWhatsAppParaTodos(mensagemFim);
        }

        // Event listeners
        elements.btnBuscar.addEventListener('click', buscarNota);
        elements.btnAdicionarFila.addEventListener('click', adicionarFila);
        elements.btnProcessarFila.addEventListener('click', processarFila);
        elements.btnModoNota.addEventListener('click', () => alternarModo('nota'));
        elements.btnModoPeriodo.addEventListener('click', () => alternarModo('periodo'));
        elements.btnModoPedido.addEventListener('click', () => alternarModo('pedido'));
        elements.btnListarNotas.addEventListener('click', listarNotasPorPeriodo);
        elements.btnSelecionarTodas.addEventListener('click', selecionarTodasNotas);
        elements.btnDeselecionarTodas.addEventListener('click', deselecionarTodasNotas);
        elements.btnCarregarSelecionadas.addEventListener('click', carregarNotasSelecionadas);
        elements.btnExportarNotas.addEventListener('click', exportarNotasCsv);
        elements.btnBuscarPedido.addEventListener('click', buscarPedido);
        elements.btnBuscarReversas.addEventListener('click', buscarReversasTroque);
        elements.valorMin.addEventListener('input', () => {
            if (state.notasEncontradas.length === 0) return;
            aplicarFiltrosNotas();
        });
        elements.valorMax.addEventListener('input', () => {
            if (state.notasEncontradas.length === 0) return;
            aplicarFiltrosNotas();
        });

        elements.numeroNota.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') buscarNota();
        });

        elements.numeroPedido.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') buscarPedido();
        });

        // Persist√™ncia de configura√ß√µes
        loadConfigFromStorage();
        setupConfigPersistence();
        startScheduleWatcher();

        // Inicializa√ß√£o
        // Definir datas padr√£o (mesmo dia - hoje)
        const hoje = new Date();
        const formatoISO = (date) => date.toISOString().split('T')[0];
        const seteDiasAtras = new Date(hoje);
        seteDiasAtras.setDate(hoje.getDate() - 7);
        
        elements.dataInicial.value = formatoISO(hoje);
        elements.dataFinal.value = formatoISO(hoje);
        elements.notaDataInicial.value = formatoISO(seteDiasAtras);
        elements.notaDataFinal.value = formatoISO(hoje);

        // Event listeners para navega√ß√£o principal
        initNavigation();
        initTabs();
        elements.btnBuscarEventos.addEventListener('click', buscarEventosWebhook);

        // Event listeners para sele√ß√£o e pagina√ß√£o de reversas
        elements.selectAllReversas.addEventListener('change', (e) => {
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const endIndex = startIndex + state.itemsPerPage;
            const pageReversas = state.troqueReversas.slice(startIndex, endIndex);
            
            if (e.target.checked) {
                // Marcar todos da p√°gina
                for (let i = 0; i < pageReversas.length; i++) {
                    state.selectedReversas.add(startIndex + i);
                }
            } else {
                // Desmarcar todos da p√°gina
                for (let i = 0; i < pageReversas.length; i++) {
                    state.selectedReversas.delete(startIndex + i);
                }
            }
            
            updateSelectedCount();
            renderTroqueReversas();
        });

        elements.btnAdicionarSelecionadas.addEventListener('click', adicionarSelecionadasAFila);

        // Event listeners para Dashboard e Automa√ß√£o
        elements.btnStartAutomation.addEventListener('click', startAutomation);
        elements.btnStopAutomation.addEventListener('click', stopAutomation);

        // Event listeners para filtros do Dashboard
        elements.dashboardPeriod.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                document.getElementById('dashboardDateRange').style.display = 'block';
                document.getElementById('dashboardDateRangeEnd').style.display = 'block';
            } else {
                document.getElementById('dashboardDateRange').style.display = 'none';
                document.getElementById('dashboardDateRangeEnd').style.display = 'none';
            }
        });

        // Carregar configura√ß√µes salvas
        loadConfig();

        // Inicializar dashboard (p√°gina principal)
        setTimeout(refreshDashboard, 1000);
        
        // Iniciar atualiza√ß√£o autom√°tica do dashboard (p√°gina principal)
        setTimeout(startDashboardAutoUpdate, 1500);

        console.log('‚úÖ H&M - Sistema de Troca/Devolu√ß√£o Automatizado carregado!');

        // Limpar timers ao fechar a p√°gina
        window.addEventListener('beforeunload', () => {
            stopDashboardAutoUpdate();
            stopAutomation();
        });
    </script>
</body>
</html>
